import { DOCUMENT } from '@angular/common';
import { inject, signal } from '@angular/core';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { assertInjector } from 'ngxtension/assert-injector';
import { fromEvent, map, merge, startWith } from 'rxjs';
/**
 * This injector is useful for tracking the current network state of the user. It provides information about the system's connection type, such as 'wifi' or 'cellular'. This utility, along with a singular property added to the Navigator interface (Navigator.connection), allows for the identification of the general type of network connection a system is using. This functionality is particularly useful for choosing between high definition or low definition content depending on the user's network connection.
 *
 * @example
 * ```ts
 * const network = injectNetwork();
 * effect(() => {
 *  console.log(this.network.type());
 *  console.log(this.network.downlink());
 *  console.log(this.network.downlinkMax());
 *  console.log(this.network.effectiveType());
 *  console.log(this.network.rtt());
 *  console.log(this.network.saveData());
 *  console.log(this.network.online());
 *  console.log(this.network.offlineAt());
 *  console.log(this.network.onlineAt());
 *  console.log(this.network.supported());
 *  });
 *  ```
 *
 * @param options An optional object with the following properties:
 *   - `window`: (Optional) Specifies a custom `Window` instance. This is useful when working with iframes or in testing environments where the global `window` might not be appropriate.
 *   - `injector`: (Optional) Specifies a custom `Injector` instance for dependency injection. This allows for more flexible and testable code by decoupling from a global state or context.
 *
 * @returns A readonly object with the following properties:
 *  - `supported`: A signal that emits `true` if the browser supports the Network Information API, otherwise `false`.
 *  - `online`: A signal that emits `true` if the user is online, otherwise `false`.
 *  - `offlineAt`: A signal that emits the time since the user was last connected.
 *  - `onlineAt`: A signal that emits the time since the user was last disconnected.
 *  - `downlink`: A signal that emits the download speed in Mbps.
 *  - `downlinkMax`: A signal that emits the max reachable download speed in Mbps.
 *  - `effectiveType`: A signal that emits the detected effective speed type.
 *  - `rtt`: A signal that emits the estimated effective round-trip time of the current connection.
 *  - `saveData`: A signal that emits `true` if the user activated data saver mode, otherwise `false`.
 *  - `type`: A signal that emits the detected connection/network type.
 */
export function injectNetwork({ injector, window: customWindow, } = {}) {
    return assertInjector(injectNetwork, injector, () => {
        const window = customWindow ?? inject(DOCUMENT).defaultView;
        const navigator = window?.navigator;
        const supported = signal(window?.navigator && 'connection' in window.navigator);
        const online = signal(true);
        const saveData = signal(false);
        const offlineAt = signal(undefined);
        const onlineAt = signal(undefined);
        const downlink = signal(undefined);
        const downlinkMax = signal(undefined);
        const rtt = signal(undefined);
        const effectiveType = signal(undefined);
        const type = signal('unknown');
        const connection = supported() && navigator.connection;
        const updateNetworkInformation = () => {
            if (!navigator)
                return;
            offlineAt.set(online() ? undefined : Date.now());
            onlineAt.set(online() ? Date.now() : undefined);
            if (connection) {
                downlink.set(connection.downlink);
                downlinkMax.set(connection.downlinkMax);
                effectiveType.set(connection.effectiveType);
                rtt.set(connection.rtt);
                saveData.set(connection.saveData);
                type.set(connection.type);
            }
        };
        if (window) {
            merge(fromEvent(window, 'online').pipe(map(() => true)), fromEvent(window, 'offline').pipe(map(() => false)))
                .pipe(takeUntilDestroyed())
                .subscribe((isOnline) => {
                online.set(isOnline);
                if (isOnline) {
                    onlineAt.set(Date.now());
                }
                else {
                    offlineAt.set(Date.now());
                }
            });
        }
        if (connection) {
            fromEvent(connection, 'change')
                .pipe(startWith(null), // we need to start with null to trigger the first update
            takeUntilDestroyed())
                .subscribe(() => updateNetworkInformation());
        }
        return {
            supported: supported.asReadonly(),
            online: online.asReadonly(),
            saveData: saveData.asReadonly(),
            offlineAt: offlineAt.asReadonly(),
            onlineAt: onlineAt.asReadonly(),
            downlink: downlink.asReadonly(),
            downlinkMax: downlinkMax.asReadonly(),
            effectiveType: effectiveType.asReadonly(),
            rtt: rtt.asReadonly(),
            type: type.asReadonly(),
        };
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LW5ldHdvcmsuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neHRlbnNpb24vaW5qZWN0LW5ldHdvcmsvc3JjL2luamVjdC1uZXR3b3JrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBOEIsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUEwRHhEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1DRztBQUNILE1BQU0sVUFBVSxhQUFhLENBQUMsRUFDN0IsUUFBUSxFQUNSLE1BQU0sRUFBRSxZQUFZLE1BQ0ssRUFBRTtJQUMzQixPQUFPLGNBQWMsQ0FBQyxhQUFhLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRTtRQUNuRCxNQUFNLE1BQU0sR0FBVyxZQUFZLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFdBQVksQ0FBQztRQUNyRSxNQUFNLFNBQVMsR0FBRyxNQUFNLEVBQUUsU0FBUyxDQUFDO1FBRXBDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FDdkIsTUFBTSxFQUFFLFNBQVMsSUFBSSxZQUFZLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FDckQsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0IsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFxQixTQUFT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M0IsUUFBUSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDL0IsU0FBUyxFQUFFLFNBQVMsQ0FBQyxVQUFVLEVBQUU7WUFDakMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDL0IsUUFBUSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDL0IsV0FBVyxFQUFFLFdBQVcsQ0FBQyxVQUFVLEVBQUU7WUFDckMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxVQUFVLEVBQUU7WUFDekMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxVQUFVLEVBQUU7WUFDckIsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUU7U0FDdkIsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IGluamVjdCwgc2lnbmFsLCB0eXBlIEluamVjdG9yLCB0eXBlIFNpZ25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdGFrZVVudGlsRGVzdHJveWVkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnO1xuaW1wb3J0IHsgYXNzZXJ0SW5qZWN0b3IgfSBmcm9tICduZ3h0ZW5zaW9uL2Fzc2VydC1pbmplY3Rvcic7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIG1hcCwgbWVyZ2UsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMnO1xuXG4vLyBQb3J0ZWQgZnJvbSBodHRwczovL3Z1ZXVzZS5vcmcvY29yZS91c2VOZXR3b3JrL1xuXG5leHBvcnQgdHlwZSBOZXR3b3JrVHlwZSA9XG5cdHwgJ2JsdWV0b290aCdcblx0fCAnY2VsbHVsYXInXG5cdHwgJ2V0aGVybmV0J1xuXHR8ICdub25lJ1xuXHR8ICd3aWZpJ1xuXHR8ICd3aW1heCdcblx0fCAnb3RoZXInXG5cdHwgJ3Vua25vd24nO1xuXG5leHBvcnQgdHlwZSBOZXR3b3JrRWZmZWN0aXZlVHlwZSA9ICdzbG93LTJnJyB8ICcyZycgfCAnM2cnIHwgJzRnJyB8ICc1Zyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV0d29ya1N0YXRlIHtcblx0c3VwcG9ydGVkOiBTaWduYWw8Ym9vbGVhbj47XG5cdG9ubGluZTogU2lnbmFsPGJvb2xlYW4+O1xuXHQvKipcblx0ICogVGhlIHRpbWUgc2luY2UgdGhlIHVzZXIgd2FzIGxhc3QgY29ubmVjdGVkLlxuXHQgKi9cblx0b2ZmbGluZUF0OiBTaWduYWw8bnVtYmVyIHwgdW5kZWZpbmVkPjtcblx0LyoqXG5cdCAqIEF0IHRoaXMgdGltZSwgaWYgdGhlIHVzZXIgaXMgb2ZmbGluZSBhbmQgcmVjb25uZWN0c1xuXHQgKi9cblx0b25saW5lQXQ6IFNpZ25hbDxudW1iZXIgfCB1bmRlZmluZWQ+O1xuXHQvKipcblx0ICogVGhlIGRvd25sb2FkIHNwZWVkIGluIE1icHMuXG5cdCAqL1xuXHRkb3dubGluazogU2lnbmFsPG51bWJlciB8IHVuZGVmaW5lZD47XG5cdC8qKlxuXHQgKiBUaGUgbWF4IHJlYWNoYWJsZSBkb3dubG9hZCBzcGVlZCBpbiBNYnBzLlxuXHQgKi9cblx0ZG93bmxpbmtNYXg6IFNpZ25hbDxudW1iZXIgfCB1bmRlZmluZWQ+O1xuXHQvKipcblx0ICogVGhlIGRldGVjdGVkIGVmZmVjdGl2ZSBzcGVlZCB0eXBlLlxuXHQgKi9cblx0ZWZmZWN0aXZlVHlwZTogU2lnbmFsPE5ldHdvcmtFZmZlY3RpdmVUeXBlIHwgdW5kZWZpbmVkPjtcblx0LyoqXG5cdCAqIFRoZSBlc3RpbWF0ZWQgZWZmZWN0aXZlIHJvdW5kLXRyaXAgdGltZSBvZiB0aGUgY3VycmVudCBjb25uZWN0aW9uLlxuXHQgKi9cblx0cnR0OiBTaWduYWw8bnVtYmVyIHwgdW5kZWZpbmVkPjtcblx0LyoqXG5cdCAqIElmIHRoZSB1c2VyIGFjdGl2YXRlZCBkYXRhIHNhdmVyIG1vZGUuXG5cdCAqL1xuXHRzYXZlRGF0YTogU2lnbmFsPGJvb2xlYW4gfCB1bmRlZmluZWQ+O1xuXHQvKipcblx0ICogVGhlIGRldGVjdGVkIGNvbm5lY3Rpb24vbmV0d29yayB0eXBlLlxuXHQgKi9cblx0dHlwZTogU2lnbmFsPE5ldHdvcmtUeXBlPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbmplY3ROZXR3b3JrT3B0aW9ucyB7XG5cdGluamVjdG9yPzogSW5qZWN0b3I7XG5cdHdpbmRvdz86IFdpbmRvdztcbn1cblxuLyoqXG4gKiBUaGlzIGluamVjdG9yIGlzIHVzZWZ1bCBmb3IgdHJhY2tpbmcgdGhlIGN1cnJlbnQgbmV0d29yayBzdGF0ZSBvZiB0aGUgdXNlci4gSXQgcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN5c3RlbSdzIGNvbm5lY3Rpb24gdHlwZSwgc3VjaCBhcyAnd2lmaScgb3IgJ2NlbGx1bGFyJy4gVGhpcyB1dGlsaXR5LCBhbG9uZyB3aXRoIGEgc2luZ3VsYXIgcHJvcGVydHkgYWRkZWQgdG8gdGhlIE5hdmlnYXRvciBpbnRlcmZhY2UgKE5hdmlnYXRvci5jb25uZWN0aW9uKSwgYWxsb3dzIGZvciB0aGUgaWRlbnRpZmljYXRpb24gb2YgdGhlIGdlbmVyYWwgdHlwZSBvZiBuZXR3b3JrIGNvbm5lY3Rpb24gYSBzeXN0ZW0gaXMgdXNpbmcuIFRoaXMgZnVuY3Rpb25hbGl0eSBpcyBwYXJ0aWN1bGFybHkgdXNlZnVsIGZvciBjaG9vc2luZyBiZXR3ZWVuIGhpZ2ggZGVmaW5pdGlvbiBvciBsb3cgZGVmaW5pdGlvbiBjb250ZW50IGRlcGVuZGluZyBvbiB0aGUgdXNlcidzIG5ldHdvcmsgY29ubmVjdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHNcbiAqIGNvbnN0IG5ldHdvcmsgPSBpbmplY3ROZXR3b3JrKCk7XG4gKiBlZmZlY3QoKCkgPT4ge1xuICogIGNvbnNvbGUubG9nKHRoaXMubmV0d29yay50eXBlKCkpO1xuICogIGNvbnNvbGUubG9nKHRoaXMubmV0d29yay5kb3dubGluaygpKTtcbiAqICBjb25zb2xlLmxvZyh0aGlzLm5ldHdvcmsuZG93bmxpbmtNYXgoKSk7XG4gKiAgY29uc29sZS5sb2codGhpcy5uZXR3b3JrLmVmZmVjdGl2ZVR5cGUoKSk7XG4gKiAgY29uc29sZS5sb2codGhpcy5uZXR3b3JrLnJ0dCgpKTtcbiAqICBjb25zb2xlLmxvZyh0aGlzLm5ldHdvcmsuc2F2ZURhdGEoKSk7XG4gKiAgY29uc29sZS5sb2codGhpcy5uZXR3b3JrLm9ubGluZSgpKTtcbiAqICBjb25zb2xlLmxvZyh0aGlzLm5ldHdvcmsub2ZmbGluZUF0KCkpO1xuICogIGNvbnNvbGUubG9nKHRoaXMubmV0d29yay5vbmxpbmVBdCgpKTtcbiAqICBjb25zb2xlLmxvZyh0aGlzLm5ldHdvcmsuc3VwcG9ydGVkKCkpO1xuICogIH0pO1xuICogIGBgYFxuICpcbiAqIEBwYXJhbSBvcHRpb25zIEFuIG9wdGlvbmFsIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczpcbiAqICAgLSBgd2luZG93YDogKE9wdGlvbmFsKSBTcGVjaWZpZXMgYSBjdXN0b20gYFdpbmRvd2AgaW5zdGFuY2UuIFRoaXMgaXMgdXNlZnVsIHdoZW4gd29ya2luZyB3aXRoIGlmcmFtZXMgb3IgaW4gdGVzdGluZyBlbnZpcm9ubWVudHMgd2hlcmUgdGhlIGdsb2JhbCBgd2luZG93YCBtaWdodCBub3QgYmUgYXBwcm9wcmlhdGUuXG4gKiAgIC0gYGluamVjdG9yYDogKE9wdGlvbmFsKSBTcGVjaWZpZXMgYSBjdXN0b20gYEluamVjdG9yYCBpbnN0YW5jZSBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoaXMgYWxsb3dzIGZvciBtb3JlIGZsZXhpYmxlIGFuZCB0ZXN0YWJsZSBjb2RlIGJ5IGRlY291cGxpbmcgZnJvbSBhIGdsb2JhbCBzdGF0ZSBvciBjb250ZXh0LlxuICpcbiAqIEByZXR1cm5zIEEgcmVhZG9ubHkgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOlxuICogIC0gYHN1cHBvcnRlZGA6IEEgc2lnbmFsIHRoYXQgZW1pdHMgYHRydWVgIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIHRoZSBOZXR3b3JrIEluZm9ybWF0aW9uIEFQSSwgb3RoZXJ3aXNlIGBmYWxzZWAuXG4gKiAgLSBgb25saW5lYDogQSBzaWduYWwgdGhhdCBlbWl0cyBgdHJ1ZWAgaWYgdGhlIHVzZXIgaXMgb25saW5lLCBvdGhlcndpc2UgYGZhbHNlYC5cbiAqICAtIGBvZmZsaW5lQXRgOiBBIHNpZ25hbCB0aGF0IGVtaXRzIHRoZSB0aW1lIHNpbmNlIHRoZSB1c2VyIHdhcyBsYXN0IGNvbm5lY3RlZC5cbiAqICAtIGBvbmxpbmVBdGA6IEEgc2lnbmFsIHRoYXQgZW1pdHMgdGhlIHRpbWUgc2luY2UgdGhlIHVzZXIgd2FzIGxhc3QgZGlzY29ubmVjdGVkLlxuICogIC0gYGRvd25saW5rYDogQSBzaWduYWwgdGhhdCBlbWl0cyB0aGUgZG93bmxvYWQgc3BlZWQgaW4gTWJwcy5cbiAqICAtIGBkb3dubGlua01heGA6IEEgc2lnbmFsIHRoYXQgZW1pdHMgdGhlIG1heCByZWFjaGFibGUgZG93bmxvYWQgc3BlZWQgaW4gTWJwcy5cbiAqICAtIGBlZmZlY3RpdmVUeXBlYDogQSBzaWduYWwgdGhhdCBlbWl0cyB0aGUgZGV0ZWN0ZWQgZWZmZWN0aXZlIHNwZWVkIHR5cGUuXG4gKiAgLSBgcnR0YDogQSBzaWduYWwgdGhhdCBlbWl0cyB0aGUgZXN0aW1hdGVkIGVmZmVjdGl2ZSByb3VuZC10cmlwIHRpbWUgb2YgdGhlIGN1cnJlbnQgY29ubmVjdGlvbi5cbiAqICAtIGBzYXZlRGF0YWA6IEEgc2lnbmFsIHRoYXQgZW1pdHMgYHRydWVgIGlmIHRoZSB1c2VyIGFjdGl2YXRlZCBkYXRhIHNhdmVyIG1vZGUsIG90aGVyd2lzZSBgZmFsc2VgLlxuICogIC0gYHR5cGVgOiBBIHNpZ25hbCB0aGF0IGVtaXRzIHRoZSBkZXRlY3RlZCBjb25uZWN0aW9uL25ldHdvcmsgdHlwZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdE5ldHdvcmsoe1xuXHRpbmplY3Rvcixcblx0d2luZG93OiBjdXN0b21XaW5kb3csXG59OiBJbmplY3ROZXR3b3JrT3B0aW9ucyA9IHt9KTogUmVhZG9ubHk8TmV0d29ya1N0YXRlPiB7XG5cdHJldHVybiBhc3NlcnRJbmplY3RvcihpbmplY3ROZXR3b3JrLCBpbmplY3RvciwgKCkgPT4ge1xuXHRcdGNvbnN0IHdpbmRvdzogV2luZG93ID0gY3VzdG9tV2luZG93ID8/IGluamVjdChET0NVTUVOVCkuZGVmYXVsdFZpZXchO1xuXHRcdGNvbnN0IG5hdmlnYXRvciA9IHdpbmRvdz8ubmF2aWdhdG9yO1xuXG5cdFx0Y29uc3Qgc3VwcG9ydGVkID0gc2lnbmFsKFxuXHRcdFx0d2luZG93Py5uYXZpZ2F0b3IgJiYgJ2Nvbm5lY3Rpb24nIGluIHdpbmRvdy5uYXZpZ2F0b3IsXG5cdFx0KTtcblxuXHRcdGNvbnN0IG9ubGluZSA9IHNpZ25hbCh0cnVlKTtcblx0XHRjb25zdCBzYXZlRGF0YSA9IHNpZ25hbChmYWxzZSk7XG5cdFx0Y29uc3Qgb2ZmbGluZUF0ID0gc2lnbmFsPG51bWJlciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblx0XHRjb25zdCBvbmxpbmVBdCA9IHNpZ25hbDxudW1iZXIgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cdFx0Y29uc3QgZG93bmxpbmsgPSBzaWduYWw8bnVtYmVyIHwgdW5kZWZpbmVkPih1bmRlZmluZWQpO1xuXHRcdGNvbnN0IGRvd25saW5rTWF4ID0gc2lnbmFsPG51bWJlciB8IHVuZGVmaW5lZD4odW5kZWZpbmVkKTtcblx0XHRjb25zdCBydHQgPSBzaWduYWw8bnVtYmVyIHwgdW5kZWZpbmVkPih1bmRlZmluZWQpO1xuXHRcdGNvbnN0IGVmZmVjdGl2ZVR5cGUgPSBzaWduYWw8TmV0d29ya0VmZmVjdGl2ZVR5cGUgfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cdFx0Y29uc3QgdHlwZSA9IHNpZ25hbDxOZXR3b3JrVHlwZT4oJ3Vua25vd24nKTtcblxuXHRcdGNvbnN0IGNvbm5lY3Rpb24gPSBzdXBwb3J0ZWQoKSAmJiAobmF2aWdhdG9yIGFzIGFueSkuY29ubmVjdGlvbjtcblxuXHRcdGNvbnN0IHVwZGF0ZU5ldHdvcmtJbmZvcm1hdGlvbiA9ICgpID0+IHtcblx0XHRcdGlmICghbmF2aWdhdG9yKSByZXR1cm47XG5cblx0XHRcdG9mZmxpbmVBdC5zZXQob25saW5lKCkgPyB1bmRlZmluZWQgOiBEYXRlLm5vdygpKTtcblx0XHRcdG9ubGluZUF0LnNldChvbmxpbmUoKSA/IERhdGUubm93KCkgOiB1bmRlZmluZWQpO1xuXG5cdFx0XHRpZiAoY29ubmVjdGlvbikge1xuXHRcdFx0XHRkb3dubGluay5zZXQoY29ubmVjdGlvbi5kb3dubGluayk7XG5cdFx0XHRcdGRvd25saW5rTWF4LnNldChjb25uZWN0aW9uLmRvd25saW5rTWF4KTtcblx0XHRcdFx0ZWZmZWN0aXZlVHlwZS5zZXQoY29ubmVjdGlvbi5lZmZlY3RpdmVUeXBlKTtcblx0XHRcdFx0cnR0LnNldChjb25uZWN0aW9uLnJ0dCk7XG5cdFx0XHRcdHNhdmVEYXRhLnNldChjb25uZWN0aW9uLnNhdmVEYXRhKTtcblx0XHRcdFx0dHlwZS5zZXQoY29ubmVjdGlvbi50eXBlKTtcblx0XHRcdH1cblx0XHR9O1xuXG5cdFx0aWYgKHdpbmRvdykge1xuXHRcdFx0bWVyZ2UoXG5cdFx0XHRcdGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5waXBlKG1hcCgoKSA9PiB0cnVlKSksXG5cdFx0XHRcdGZyb21FdmVudCh3aW5kb3csICdvZmZsaW5lJykucGlwZShtYXAoKCkgPT4gZmFsc2UpKSxcblx0XHRcdClcblx0XHRcdFx0LnBpcGUodGFrZVVudGlsRGVzdHJveWVkKCkpXG5cdFx0XHRcdC5zdWJzY3JpYmUoKGlzT25saW5lKSA9PiB7XG5cdFx0XHRcdFx0b25saW5lLnNldChpc09ubGluZSk7XG5cdFx0XHRcdFx0aWYgKGlzT25saW5lKSB7XG5cdFx0XHRcdFx0XHRvbmxpbmVBdC5zZXQoRGF0ZS5ub3coKSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdG9mZmxpbmVBdC5zZXQoRGF0ZS5ub3coKSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoY29ubmVjdGlvbikge1xuXHRcdFx0ZnJvbUV2ZW50KGNvbm5lY3Rpb24sICdjaGFuZ2UnKVxuXHRcdFx0XHQucGlwZShcblx0XHRcdFx0XHRzdGFydFdpdGgobnVsbCksIC8vIHdlIG5lZWQgdG8gc3RhcnQgd2l0aCBudWxsIHRvIHRyaWdnZXIgdGhlIGZpcnN0IHVwZGF0ZVxuXHRcdFx0XHRcdHRha2VVbnRpbERlc3Ryb3llZCgpLFxuXHRcdFx0XHQpXG5cdFx0XHRcdC5zdWJzY3JpYmUoKCkgPT4gdXBkYXRlTmV0d29ya0luZm9ybWF0aW9uKCkpO1xuXHRcdH1cblxuXHRcdHJldHVybiB7XG5cdFx0XHRzdXBwb3J0ZWQ6IHN1cHBvcnRlZC5hc1JlYWRvbmx5KCksXG5cdFx0XHRvbmxpbmU6IG9ubGluZS5hc1JlYWRvbmx5KCksXG5cdFx0XHRzYXZlRGF0YTogc2F2ZURhdGEuYXNSZWFkb25seSgpLFxuXHRcdFx0b2ZmbGluZUF0OiBvZmZsaW5lQXQuYXNSZWFkb25seSgpLFxuXHRcdFx0b25saW5lQXQ6IG9ubGluZUF0LmFzUmVhZG9ubHkoKSxcblx0XHRcdGRvd25saW5rOiBkb3dubGluay5hc1JlYWRvbmx5KCksXG5cdFx0XHRkb3dubGlua01heDogZG93bmxpbmtNYXguYXNSZWFkb25seSgpLFxuXHRcdFx0ZWZmZWN0aXZlVHlwZTogZWZmZWN0aXZlVHlwZS5hc1JlYWRvbmx5KCksXG5cdFx0XHRydHQ6IHJ0dC5hc1JlYWRvbmx5KCksXG5cdFx0XHR0eXBlOiB0eXBlLmFzUmVhZG9ubHkoKSxcblx0XHR9O1xuXHR9KTtcbn1cbiJdfQ==