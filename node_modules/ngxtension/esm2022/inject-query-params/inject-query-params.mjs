import { assertInInjectionContext, inject } from '@angular/core';
import { toSignal } from '@angular/core/rxjs-interop';
import { ActivatedRoute } from '@angular/router';
import { map } from 'rxjs';
/**
 * The `injectQueryParams` function allows you to access and manipulate query parameters from the current route.
 *
 * @template ReadT - The expected type of the read value.
 * @param {string} keyOrParamsTransform - The name of the query parameter to retrieve, or a transform function to apply to the query parameters object.
 * @param {QueryParamsOptions} options - Optional configuration options for the query parameter.
 * @returns {QueryParamsOptions} A `Signal` that emits the transformed value of the specified query parameter, or the entire query parameters object if no key is provided.
 *
 * @example
 * const search = injectQueryParams('search'); // returns the value of the 'search' query param
 * const search = injectQueryParams(p => p['search'] as string); // same as above but can be used with a custom transform function
 * const idParam = injectQueryParams('id', {transform: numberAttribute}); // returns the value fo the 'id' query params and transforms it into a number
 * const idParam = injectQueryParams(p => numberAttribute(p['id'])); // same as above but can be used with a custom transform function
 * const queryParams = injectQueryParams(); // returns the entire query params object
 */
export function injectQueryParams(keyOrParamsTransform, options = {}) {
    assertInInjectionContext(injectQueryParams);
    const route = inject(ActivatedRoute);
    const queryParams = route.snapshot.queryParams || {};
    const { transform, initialValue } = options;
    if (!keyOrParamsTransform) {
        return toSignal(route.queryParams, { initialValue: queryParams });
    }
    if (typeof keyOrParamsTransform === 'function') {
        return toSignal(route.queryParams.pipe(map(keyOrParamsTransform)), {
            initialValue: keyOrParamsTransform(queryParams),
        });
    }
    const getParam = (params) => {
        const param = params?.[keyOrParamsTransform];
        if (!param) {
            return initialValue ?? null;
        }
        if (Array.isArray(param)) {
            if (param.length < 1) {
                return initialValue ?? null;
            }
            return transform ? transform(param[0]) : param[0];
        }
        return transform ? transform(param) : param;
    };
    return toSignal(route.queryParams.pipe(map(getParam)), {
        initialValue: getParam(queryParams),
    });
}
/**
 * The `injectQueryParams` function namespace provides additional functionality for handling array query parameters.
 */
(function (injectQueryParams) {
    /**
     * Retrieve an array query parameter with optional configuration options.
     *
     * @template ReadT - The expected type of the read value.
     * @param {string} key - The name of the array query parameter to retrieve.
     * @param {QueryParamsOptions} options - Optional configuration options for the array query parameter.
     * @returns {Signal} A `Signal` that emits an array of transformed values for the specified query parameter, or `null` if it's not present.
     */
    function array(key, options = {}) {
        assertInInjectionContext(injectQueryParams.array);
        const route = inject(ActivatedRoute);
        const queryParams = route.snapshot.queryParams || {};
        const { transform, initialValue } = options;
        const transformParam = (param) => {
            if (!param) {
                return initialValue ?? null;
            }
            if (Array.isArray(param)) {
                if (param.length < 1) {
                    return initialValue ?? null;
                }
                // Avoid passing the transform function directly into the map function,
                // because transform may inadvertently use the array index as its second argument.
                // Typically, map provides the array index as the second argument to its callback,
                // which can conflict with transform functions like numberAttribute that expect a fallbackValue as their second parameter.
                // This mismatch can lead to unexpected behavior, such as values being erroneously converted to array indices
                // instead of NaN (which would be correct)
                return transform ? param.map((it) => transform(it)) : param;
            }
            return [transform ? transform(param) : param];
        };
        const getParam = (params) => {
            const param = params?.[key];
            return transformParam(param);
        };
        return toSignal(route.queryParams.pipe(map(getParam)), {
            initialValue: getParam(queryParams),
        });
    }
    injectQueryParams.array = array;
})(injectQueryParams || (injectQueryParams = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LXF1ZXJ5LXBhcmFtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4dGVuc2lvbi9pbmplY3QtcXVlcnktcGFyYW1zL3NyYy9pbmplY3QtcXVlcnktcGFyYW1zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFDOUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQWUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBNEYzQjs7Ozs7Ozs7Ozs7Ozs7R0FjRztBQUNILE1BQU0sVUFBVSxpQkFBaUIsQ0FDaEMsb0JBQTJELEVBQzNELFVBQW9ELEVBQUU7SUFFdEQsd0JBQXdCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM1QyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDckMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO0lBRXJELE1BQU0sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEdBQUcsT0FBTyxDQUFDO0lBRTVDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzNCLE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsSUFBSSxPQUFPLG9CQUFvQixLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQ2hELE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEVBQUU7WUFDbEUsWUFBWSxFQUFFLG9CQUFvQixDQUFDLFdB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QVEsQ0FBQyxXQUFXLENBQUM7U0FDbkMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQXhDZSx1QkFBSyxRQXdDcEIsQ0FBQTtBQUNGLENBQUMsRUF0RmdCLGlCQUFpQixLQUFqQixpQkFBaUIsUUFzRmpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzZXJ0SW5JbmplY3Rpb25Db250ZXh0LCBpbmplY3QsIHR5cGUgU2lnbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0b1NpZ25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCB0eXBlIFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzJztcblxudHlwZSBRdWVyeVBhcmFtc1RyYW5zZm9ybUZuPFJlYWRUPiA9IChwYXJhbXM6IFBhcmFtcykgPT4gUmVhZFQ7XG5cbi8qKlxuICogVGhlIGBJbnB1dE9wdGlvbnNgIGludGVyZmFjZSBkZWZpbmVzIG9wdGlvbnMgZm9yIGNvbmZpZ3VyaW5nIHRoZSBiZWhhdmlvciBvZiB0aGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbi5cbiAqXG4gKiBAdGVtcGxhdGUgUmVhZFQgLSBUaGUgZXhwZWN0ZWQgdHlwZSBvZiB0aGUgcmVhZCB2YWx1ZS5cbiAqIEB0ZW1wbGF0ZSBXcml0ZVQgLSBUaGUgdHlwZSBvZiB0aGUgdmFsdWUgdG8gYmUgd3JpdHRlbi5cbiAqIEB0ZW1wbGF0ZSBJbml0aWFsVmFsdWVUIC0gVGhlIHR5cGUgb2YgdGhlIGluaXRpYWwgdmFsdWUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlQYXJhbXNPcHRpb25zPFJlYWRULCBXcml0ZVQsIEluaXRpYWxWYWx1ZVQ+IHtcblx0LyoqXG5cdCAqIEEgdHJhbnNmb3JtYXRpb24gZnVuY3Rpb24gdG8gY29udmVydCB0aGUgd3JpdHRlbiB2YWx1ZSB0byB0aGUgZXhwZWN0ZWQgcmVhZCB2YWx1ZS5cblx0ICpcblx0ICogQHBhcmFtIHYgLSBUaGUgdmFsdWUgdG8gdHJhbnNmb3JtLlxuXHQgKiBAcmV0dXJucyBUaGUgdHJhbnNmb3JtZWQgdmFsdWUuXG5cdCAqL1xuXHR0cmFuc2Zvcm0/OiAodjogV3JpdGVUKSA9PiBSZWFkVDtcblxuXHQvKipcblx0ICogVGhlIGluaXRpYWwgdmFsdWUgdG8gdXNlIGlmIHRoZSBxdWVyeSBwYXJhbWV0ZXIgaXMgbm90IHByZXNlbnQgb3IgdW5kZWZpbmVkLlxuXHQgKi9cblx0aW5pdGlhbFZhbHVlPzogSW5pdGlhbFZhbHVlVDtcbn1cblxuLyoqXG4gKiBUaGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIGFjY2VzcyBhbmQgbWFuaXB1bGF0ZSBxdWVyeSBwYXJhbWV0ZXJzIGZyb20gdGhlIGN1cnJlbnQgcm91dGUuXG4gKlxuICogQHJldHVybnMgQSBgU2lnbmFsYCB0aGF0IGVtaXRzIHRoZSBlbnRpcmUgcXVlcnkgcGFyYW1ldGVycyBvYmplY3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtcygpOiBTaWduYWw8UGFyYW1zPjtcblxuLyoqXG4gKiBUaGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIGFjY2VzcyBhbmQgbWFuaXB1bGF0ZSBxdWVyeSBwYXJhbWV0ZXJzIGZyb20gdGhlIGN1cnJlbnQgcm91dGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBuYW1lIG9mIHRoZSBxdWVyeSBwYXJhbWV0ZXIgdG8gcmV0cmlldmUuXG4gKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgdGhlIHZhbHVlIG9mIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciBgbnVsbGAgaWYgaXQncyBub3QgcHJlc2VudC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFF1ZXJ5UGFyYW1zKGtleTogc3RyaW5nKTogU2lnbmFsPHN0cmluZyB8IG51bGw+O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cbiAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgcXVlcnkgcGFyYW1ldGVyLlxuICogQHJldHVybnMge1NpZ25hbH0gQSBgU2lnbmFsYCB0aGF0IGVtaXRzIHRoZSB0cmFuc2Zvcm1lZCB2YWx1ZSBvZiB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtcyhcblx0a2V5Pzogc3RyaW5nLFxuXHRvcHRpb25zPzogUXVlcnlQYXJhbXNPcHRpb25zPGJvb2xlYW4sIHN0cmluZywgYm9vbGVhbj4sXG4pOiBTaWduYWw8Ym9vbGVhbiB8IG51bGw+O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cbiAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgcXVlcnkgcGFyYW1ldGVyLlxuICogQHJldHVybnMge1NpZ25hbH0gQSBgU2lnbmFsYCB0aGF0IGVtaXRzIHRoZSB0cmFuc2Zvcm1lZCB2YWx1ZSBvZiB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtcyhcblx0a2V5Pzogc3RyaW5nLFxuXHRvcHRpb25zPzogUXVlcnlQYXJhbXNPcHRpb25zPG51bWJlciwgc3RyaW5nLCBudW1iZXI+LFxuKTogU2lnbmFsPG51bWJlciB8IG51bGw+O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cbiAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgcXVlcnkgcGFyYW1ldGVyLlxuICogQHJldHVybnMge1NpZ25hbH0gQSBgU2lnbmFsYCB0aGF0IGVtaXRzIHRoZSB0cmFuc2Zvcm1lZCB2YWx1ZSBvZiB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtcyhcblx0a2V5Pzogc3RyaW5nLFxuXHRvcHRpb25zPzogUXVlcnlQYXJhbXNPcHRpb25zPHN0cmluZywgc3RyaW5nLCBzdHJpbmc+LFxuKTogU2lnbmFsPHN0cmluZyB8IG51bGw+O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqIEl0IHJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBxdWVyeSBwYXJhbWV0ZXIgYmFzZWQgb24gYSBjdXN0b20gdHJhbnNmb3JtIGZ1bmN0aW9uIGFwcGxpZWQgdG8gdGhlIHF1ZXJ5IHBhcmFtZXRlcnMgb2JqZWN0LlxuICpcbiAqIEB0ZW1wbGF0ZSBSZWFkVCAtIFRoZSBleHBlY3RlZCB0eXBlIG9mIHRoZSByZWFkIHZhbHVlLlxuICogQHBhcmFtIHtRdWVyeVBhcmFtc1RyYW5zZm9ybUZuPFJlYWRUPn0gZm4gLSBBIHRyYW5zZm9ybSBmdW5jdGlvbiB0aGF0IHRha2VzIHRoZSBxdWVyeSBwYXJhbWV0ZXJzIG9iamVjdCAoYHBhcmFtczogUGFyYW1zYCkgYW5kIHJldHVybnMgdGhlIGRlc2lyZWQgdmFsdWUuXG4gKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgdGhlIHRyYW5zZm9ybWVkIHZhbHVlIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBjdXN0b20gdHJhbnNmb3JtIGZ1bmN0aW9uLlxuICpcbiAqIEBleGFtcGxlXG4gKiBjb25zdCBzZWFyY2hWYWx1ZSA9IGluamVjdFF1ZXJ5UGFyYW1zKChwYXJhbXMpID0+IHBhcmFtc1snc2VhcmNoJ10gYXMgc3RyaW5nKTtcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFF1ZXJ5UGFyYW1zPFJlYWRUPihcblx0Zm46IFF1ZXJ5UGFyYW1zVHJhbnNmb3JtRm48UmVhZFQ+LFxuKTogU2lnbmFsPFJlYWRUPjtcblxuLyoqXG4gKiBUaGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIGFjY2VzcyBhbmQgbWFuaXB1bGF0ZSBxdWVyeSBwYXJhbWV0ZXJzIGZyb20gdGhlIGN1cnJlbnQgcm91dGUuXG4gKlxuICogQHRlbXBsYXRlIFJlYWRUIC0gVGhlIGV4cGVjdGVkIHR5cGUgb2YgdGhlIHJlYWQgdmFsdWUuXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5T3JQYXJhbXNUcmFuc2Zvcm0gLSBUaGUgbmFtZSBvZiB0aGUgcXVlcnkgcGFyYW1ldGVyIHRvIHJldHJpZXZlLCBvciBhIHRyYW5zZm9ybSBmdW5jdGlvbiB0byBhcHBseSB0byB0aGUgcXVlcnkgcGFyYW1ldGVycyBvYmplY3QuXG4gKiBAcGFyYW0ge1F1ZXJ5UGFyYW1zT3B0aW9uc30gb3B0aW9ucyAtIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHF1ZXJ5IHBhcmFtZXRlci5cbiAqIEByZXR1cm5zIHtRdWVyeVBhcmFtc09wdGlvbnN9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyB0aGUgdHJhbnNmb3JtZWQgdmFsdWUgb2YgdGhlIHNwZWNpZmllZCBxdWVyeSBwYXJhbWV0ZXIsIG9yIHRoZSBlbnRpcmUgcXVlcnkgcGFyYW1ldGVycyBvYmplY3QgaWYgbm8ga2V5IGlzIHByb3ZpZGVkLlxuICpcbiAqIEBleGFtcGxlXG4gKiBjb25zdCBzZWFyY2ggPSBpbmplY3RRdWVyeVBhcmFtcygnc2VhcmNoJyk7IC8vIHJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSAnc2VhcmNoJyBxdWVyeSBwYXJhbVxuICogY29uc3Qgc2VhcmNoID0gaW5qZWN0UXVlcnlQYXJhbXMocCA9PiBwWydzZWFyY2gnXSBhcyBzdHJpbmcpOyAvLyBzYW1lIGFzIGFib3ZlIGJ1dCBjYW4gYmUgdXNlZCB3aXRoIGEgY3VzdG9tIHRyYW5zZm9ybSBmdW5jdGlvblxuICogY29uc3QgaWRQYXJhbSA9IGluamVjdFF1ZXJ5UGFyYW1zKCdpZCcsIHt0cmFuc2Zvcm06IG51bWJlckF0dHJpYnV0ZX0pOyAvLyByZXR1cm5zIHRoZSB2YWx1ZSBmbyB0aGUgJ2lkJyBxdWVyeSBwYXJhbXMgYW5kIHRyYW5zZm9ybXMgaXQgaW50byBhIG51bWJlclxuICogY29uc3QgaWRQYXJhbSA9IGluamVjdFF1ZXJ5UGFyYW1zKHAgPT4gbnVtYmVyQXR0cmlidXRlKHBbJ2lkJ10pKTsgLy8gc2FtZSBhcyBhYm92ZSBidXQgY2FuIGJlIHVzZWQgd2l0aCBhIGN1c3RvbSB0cmFuc2Zvcm0gZnVuY3Rpb25cbiAqIGNvbnN0IHF1ZXJ5UGFyYW1zID0gaW5qZWN0UXVlcnlQYXJhbXMoKTsgLy8gcmV0dXJucyB0aGUgZW50aXJlIHF1ZXJ5IHBhcmFtcyBvYmplY3RcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFF1ZXJ5UGFyYW1zPFJlYWRUPihcblx0a2V5T3JQYXJhbXNUcmFuc2Zvcm0/OiBzdHJpbmcgfCAoKHBhcmFtczogUGFyYW1zKSA9PiBSZWFkVCksXG5cdG9wdGlvbnM6IFF1ZXJ5UGFyYW1zT3B0aW9uczxSZWFkVCwgc3RyaW5nLCBSZWFkVD4gPSB7fSxcbik6IFNpZ25hbDxSZWFkVCB8IFBhcmFtcyB8IHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXIgfCBudWxsPiB7XG5cdGFzc2VydEluSW5qZWN0aW9uQ29udGV4dChpbmplY3RRdWVyeVBhcmFtcyk7XG5cdGNvbnN0IHJvdXRlID0gaW5qZWN0KEFjdGl2YXRlZFJvdXRlKTtcblx0Y29uc3QgcXVlcnlQYXJhbXMgPSByb3V0ZS5zbmFwc2hvdC5xdWVyeVBhcmFtcyB8fCB7fTtcblxuXHRjb25zdCB7IHRyYW5zZm9ybSwgaW5pdGlhbFZhbHVlIH0gPSBvcHRpb25zO1xuXG5cdGlmICgha2V5T3JQYXJhbXNUcmFuc2Zvcm0pIHtcblx0XHRyZXR1cm4gdG9TaWduYWwocm91dGUucXVlcnlQYXJhbXMsIHsgaW5pdGlhbFZhbHVlOiBxdWVyeVBhcmFtcyB9KTtcblx0fVxuXG5cdGlmICh0eXBlb2Yga2V5T3JQYXJhbXNUcmFuc2Zvcm0gPT09ICdmdW5jdGlvbicpIHtcblx0XHRyZXR1cm4gdG9TaWduYWwocm91dGUucXVlcnlQYXJhbXMucGlwZShtYXAoa2V5T3JQYXJhbXNUcmFuc2Zvcm0pKSwge1xuXHRcdFx0aW5pdGlhbFZhbHVlOiBrZXlPclBhcmFtc1RyYW5zZm9ybShxdWVyeVBhcmFtcyksXG5cdFx0fSk7XG5cdH1cblxuXHRjb25zdCBnZXRQYXJhbSA9IChwYXJhbXM6IFBhcmFtcykgPT4ge1xuXHRcdGNvbnN0IHBhcmFtID0gcGFyYW1zPy5ba2V5T3JQYXJhbXNUcmFuc2Zvcm1dIGFzXG5cdFx0XHR8IHN0cmluZ1xuXHRcdFx0fCBzdHJpbmdbXVxuXHRcdFx0fCB1bmRlZmluZWQ7XG5cblx0XHRpZiAoIXBhcmFtKSB7XG5cdFx0XHRyZXR1cm4gaW5pdGlhbFZhbHVlID8/IG51bGw7XG5cdFx0fVxuXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkocGFyYW0pKSB7XG5cdFx0XHRpZiAocGFyYW0ubGVuZ3RoIDwgMSkge1xuXHRcdFx0XHRyZXR1cm4gaW5pdGlhbFZhbHVlID8/IG51bGw7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gdHJhbnNmb3JtID8gdHJhbnNmb3JtKHBhcmFtWzBdKSA6IHBhcmFtWzBdO1xuXHRcdH1cblxuXHRcdHJldHVybiB0cmFuc2Zvcm0gPyB0cmFuc2Zvcm0ocGFyYW0pIDogcGFyYW07XG5cdH07XG5cblx0cmV0dXJuIHRvU2lnbmFsKHJvdXRlLnF1ZXJ5UGFyYW1zLnBpcGUobWFwKGdldFBhcmFtKSksIHtcblx0XHRpbml0aWFsVmFsdWU6IGdldFBhcmFtKHF1ZXJ5UGFyYW1zKSxcblx0fSk7XG59XG5cbi8qKlxuICogVGhlIGBpbmplY3RRdWVyeVBhcmFtc2AgZnVuY3Rpb24gbmFtZXNwYWNlIHByb3ZpZGVzIGFkZGl0aW9uYWwgZnVuY3Rpb25hbGl0eSBmb3IgaGFuZGxpbmcgYXJyYXkgcXVlcnkgcGFyYW1ldGVycy5cbiAqL1xuZXhwb3J0IG5hbWVzcGFjZSBpbmplY3RRdWVyeVBhcmFtcyB7XG5cdC8qKlxuXHQgKiBSZXRyaWV2ZSBhbiBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgd2l0aCBvcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMuXG5cdCAqXG5cdCAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgbmFtZSBvZiB0aGUgYXJyYXkgcXVlcnkgcGFyYW1ldGVyIHRvIHJldHJpZXZlLlxuXHQgKiBAcGFyYW0ge1F1ZXJ5UGFyYW1zT3B0aW9uc30gb3B0aW9ucyAtIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGFycmF5IHF1ZXJ5IHBhcmFtZXRlci5cblx0ICogQHJldHVybnMge1NpZ25hbH0gQSBgU2lnbmFsYCB0aGF0IGVtaXRzIGFuIGFycmF5IG9mIHZhbHVlcyBmb3IgdGhlIHNwZWNpZmllZCBxdWVyeSBwYXJhbWV0ZXIsIG9yIGBudWxsYCBpZiBpdCdzIG5vdCBwcmVzZW50LlxuXHQgKi9cblx0ZXhwb3J0IGZ1bmN0aW9uIGFycmF5KFxuXHRcdGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBRdWVyeVBhcmFtc09wdGlvbnM8Ym9vbGVhbiwgc3RyaW5nLCBib29sZWFuW10+LFxuXHQpOiBTaWduYWw8Ym9vbGVhbltdIHwgbnVsbD47XG5cblx0LyoqXG5cdCAqIFJldHJpZXZlIGFuIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB3aXRoIG9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cblx0ICpcblx0ICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBuYW1lIG9mIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgdG8gcmV0cmlldmUuXG5cdCAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYXJyYXkgcXVlcnkgcGFyYW1ldGVyLlxuXHQgKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgYW4gYXJyYXkgb2YgdmFsdWVzIGZvciB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG5cdCAqL1xuXHRleHBvcnQgZnVuY3Rpb24gYXJyYXkoXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IFF1ZXJ5UGFyYW1zT3B0aW9uczxudW1iZXIsIHN0cmluZywgbnVtYmVyW10+LFxuXHQpOiBTaWduYWw8bnVtYmVyW10gfCBudWxsPjtcblxuXHQvKipcblx0ICogUmV0cmlldmUgYW4gYXJyYXkgcXVlcnkgcGFyYW1ldGVyIHdpdGggb3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zLlxuXHQgKlxuXHQgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cblx0ICogQHBhcmFtIHtRdWVyeVBhcmFtc09wdGlvbnN9IG9wdGlvbnMgLSBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIuXG5cdCAqIEByZXR1cm5zIHtTaWduYWx9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyBhbiBhcnJheSBvZiB2YWx1ZXMgZm9yIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciBgbnVsbGAgaWYgaXQncyBub3QgcHJlc2VudC5cblx0ICovXG5cdGV4cG9ydCBmdW5jdGlvbiBhcnJheShcblx0XHRrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogUXVlcnlQYXJhbXNPcHRpb25zPHN0cmluZywgc3RyaW5nLCBzdHJpbmdbXT4sXG5cdCk6IFNpZ25hbDxzdHJpbmdbXSB8IG51bGw+O1xuXG5cdC8qKlxuXHQgKiBSZXRyaWV2ZSBhbiBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgd2l0aCBvcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMuXG5cdCAqXG5cdCAqIEB0ZW1wbGF0ZSBSZWFkVCAtIFRoZSBleHBlY3RlZCB0eXBlIG9mIHRoZSByZWFkIHZhbHVlLlxuXHQgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cblx0ICogQHBhcmFtIHtRdWVyeVBhcmFtc09wdGlvbnN9IG9wdGlvbnMgLSBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIuXG5cdCAqIEByZXR1cm5zIHtTaWduYWx9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyBhbiBhcnJheSBvZiB0cmFuc2Zvcm1lZCB2YWx1ZXMgZm9yIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciBgbnVsbGAgaWYgaXQncyBub3QgcHJlc2VudC5cblx0ICovXG5cdGV4cG9ydCBmdW5jdGlvbiBhcnJheTxSZWFkVD4oXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9uczogUXVlcnlQYXJhbXNPcHRpb25zPFJlYWRULCBzdHJpbmcsIFJlYWRUW10+ID0ge30sXG5cdCk6IFNpZ25hbDwoUmVhZFQgfCBzdHJpbmcpW10gfCBudWxsPiB7XG5cdFx0YXNzZXJ0SW5JbmplY3Rpb25Db250ZXh0KGluamVjdFF1ZXJ5UGFyYW1zLmFycmF5KTtcblx0XHRjb25zdCByb3V0ZSA9IGluamVjdChBY3RpdmF0ZWRSb3V0ZSk7XG5cdFx0Y29uc3QgcXVlcnlQYXJhbXMgPSByb3V0ZS5zbmFwc2hvdC5xdWVyeVBhcmFtcyB8fCB7fTtcblxuXHRcdGNvbnN0IHsgdHJhbnNmb3JtLCBpbml0aWFsVmFsdWUgfSA9IG9wdGlvbnM7XG5cblx0XHRjb25zdCB0cmFuc2Zvcm1QYXJhbSA9IChcblx0XHRcdHBhcmFtOiBzdHJpbmcgfCBzdHJpbmdbXSB8IG51bGwsXG5cdFx0KTogKHN0cmluZyB8IFJlYWRUKVtdIHwgbnVsbCA9PiB7XG5cdFx0XHRpZiAoIXBhcmFtKSB7XG5cdFx0XHRcdHJldHVybiBpbml0aWFsVmFsdWUgPz8gbnVsbDtcblx0XHRcdH1cblx0XHRcdGlmIChBcnJheS5pc0FycmF5KHBhcmFtKSkge1xuXHRcdFx0XHRpZiAocGFyYW0ubGVuZ3RoIDwgMSkge1xuXHRcdFx0XHRcdHJldHVybiBpbml0aWFsVmFsdWUgPz8gbnVsbDtcblx0XHRcdFx0fVxuXHRcdFx0XHQvLyBBdm9pZCBwYXNzaW5nIHRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gZGlyZWN0bHkgaW50byB0aGUgbWFwIGZ1bmN0aW9uLFxuXHRcdFx0XHQvLyBiZWNhdXNlIHRyYW5zZm9ybSBtYXkgaW5hZHZlcnRlbnRseSB1c2UgdGhlIGFycmF5IGluZGV4IGFzIGl0cyBzZWNvbmQgYXJndW1lbnQuXG5cdFx0XHRcdC8vIFR5cGljYWxseSwgbWFwIHByb3ZpZGVzIHRoZSBhcnJheSBpbmRleCBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50IHRvIGl0cyBjYWxsYmFjayxcblx0XHRcdFx0Ly8gd2hpY2ggY2FuIGNvbmZsaWN0IHdpdGggdHJhbnNmb3JtIGZ1bmN0aW9ucyBsaWtlIG51bWJlckF0dHJpYnV0ZSB0aGF0IGV4cGVjdCBhIGZhbGxiYWNrVmFsdWUgYXMgdGhlaXIgc2Vjb25kIHBhcmFtZXRlci5cblx0XHRcdFx0Ly8gVGhpcyBtaXNtYXRjaCBjYW4gbGVhZCB0byB1bmV4cGVjdGVkIGJlaGF2aW9yLCBzdWNoIGFzIHZhbHVlcyBiZWluZyBlcnJvbmVvdXNseSBjb252ZXJ0ZWQgdG8gYXJyYXkgaW5kaWNlc1xuXHRcdFx0XHQvLyBpbnN0ZWFkIG9mIE5hTiAod2hpY2ggd291bGQgYmUgY29ycmVjdClcblx0XHRcdFx0cmV0dXJuIHRyYW5zZm9ybSA/IHBhcmFtLm1hcCgoaXQpID0+IHRyYW5zZm9ybShpdCkpIDogcGFyYW07XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gW3RyYW5zZm9ybSA/IHRyYW5zZm9ybShwYXJhbSkgOiBwYXJhbV07XG5cdFx0fTtcblxuXHRcdGNvbnN0IGdldFBhcmFtID0gKHBhcmFtczogUGFyYW1zKSA9PiB7XG5cdFx0XHRjb25zdCBwYXJhbSA9IHBhcmFtcz8uW2tleV07XG5cblx0XHRcdHJldHVybiB0cmFuc2Zvcm1QYXJhbShwYXJhbSk7XG5cdFx0fTtcblxuXHRcdHJldHVybiB0b1NpZ25hbChyb3V0ZS5xdWVyeVBhcmFtcy5waXBlKG1hcChnZXRQYXJhbSkpLCB7XG5cdFx0XHRpbml0aWFsVmFsdWU6IGdldFBhcmFtKHF1ZXJ5UGFyYW1zKSxcblx0XHR9KTtcblx0fVxufVxuIl19