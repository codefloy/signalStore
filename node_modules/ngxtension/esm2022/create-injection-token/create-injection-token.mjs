import { ENVIRONMENT_INITIALIZER, InjectionToken, inject, runInInjectionContext, } from '@angular/core';
import { assertInjector } from 'ngxtension/assert-injector';
function createInjectFn(token) {
    return function ({ injector, ...injectOptions } = {}) {
        injector = assertInjector(this, injector);
        return runInInjectionContext(injector, () => inject(token, injectOptions));
    };
}
function createProvideFn(token, factory, opts = {}) {
    const { deps = [], multi = false, extraProviders = [], isFunctionValue: isFunctionValueFromOpts = false, } = opts;
    return (value, isFunctionValue = isFunctionValueFromOpts) => {
        let provider;
        if (typeof value !== 'undefined') {
            // TODO: (chau) maybe this can be made better
            const factory = typeof value === 'function'
                ? isFunctionValue
                    ? () => value
                    : value
                : () => value;
            provider = {
                provide: token,
                useFactory: factory,
                multi,
            };
        }
        else {
            provider = {
                provide: token,
                useFactory: factory,
                deps: deps,
                multi,
            };
        }
        return [extraProviders, provider];
    };
}
/**
 * `createInjectionToken` accepts a factory function and returns a tuple of `injectFn`, `provideFn`, and the `InjectionToken`
 * that the factory function is for.
 *
 * @param {Function} factory - Factory Function that returns the value for the `InjectionToken`
 * @param {CreateInjectionTokenOptions} options - object to control how the `InjectionToken` behaves
 * @returns {CreateInjectionTokenReturn}
 *
 * @example
 * ```ts
 * const [injectCounter, provideCounter, COUNTER] = createInjectionToken(() => signal(0));
 *
 * export class Counter {
 *  counter = injectCounter(); // WritableSignal<number>
 * }
 * ```
 */
export function createInjectionToken(factory, options) {
    const tokenName = factory.name || factory.toString();
    const opts = options ??
        { isRoot: true };
    opts.isRoot ??= true;
    // NOTE: multi tokens cannot be a root token. It has to be provided (provideFn needs to be invoked)
    // for the 'multi' flag to work properly
    if (opts.multi) {
        opts.isRoot = false;
    }
    if (opts.isRoot) {
        if (opts.token) {
            throw new Error(`\
createInjectionToken is creating a root InjectionToken but an external token is passed in.
`);
        }
        const token = new InjectionToken(`Token for ${tokenName}`, {
            factory: () => {
                if (opts.deps && Array.isArray(opts.deps)) {
                    return factory(...opts.deps.map((dep) => {
                        dep = (Array.isArray(dep) ? dep.at(-1) : dep);
                        return inject(dep);
                    }));
                }
                return factory();
            },
        });
        const injectFn = createInjectFn(token);
        return [
            injectFn,
            createProvideFn(token, factory, opts),
            token,
            () => ({
                provide: ENVIRONMENT_INITIALIZER,
                useValue: () => injectFn(),
                multi: true,
            }),
        ];
    }
    const token = opts.token || new InjectionToken(`Token for ${tokenName}`);
    return [
        createInjectFn(token),
        createProvideFn(token, factory, opts),
        token,
        () => [],
    ];
}
export function createNoopInjectionToken(description, options) {
    const token = options?.token ||
        new InjectionToken(description);
    return [
        createInjectFn(token),
        createProvideFn(token, () => null, (options || {})),
        token,
        () => [],
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWluamVjdGlvbi10b2tlbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4dGVuc2lvbi9jcmVhdGUtaW5qZWN0aW9uLXRva2VuL3NyYy9jcmVhdGUtaW5qZWN0aW9uLXRva2VuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTix1QkFBdUIsRUFDdkIsY0FBYyxFQUNkLE1BQU0sRUFDTixxQkFBcUIsR0FXckIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBNEU1RCxTQUFTLGNBQWMsQ0FBUyxLQUE2QjtJQUM1RCxPQUFPLFVBRU4sRUFDQyxRQUFRLEVBQ1IsR0FBRyxhQUFhLEtBQzRCLEVBQUU7UUFFL0MsUUFBUSxHQUFHLGNBQWMsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUMsT0FBTyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQzNDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsYUFBOEIsQ0FBQyxDQUM3QyxDQUFDO0lBQ0gsQ0FBQyxDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUt2QixLQUE2QixFQUM3QixPQUFtQyxFQUNuQyxPQUF1RCxFQUFFO0lBRXpELE1BQU0sRUFDTCxJQUFJLEdBQUcsRUFBRSxFQUNULEtBQUssR0FBRyxLQUFLLEVBQ2IsY0FBYyxHQUFHLEVBQUUsRUFDbkIsZUFBZSxFQUFFLHVCQUF1QixHQUFHLEtBQUssR0FDaEQsR0FBRyxJQUFJLENBQUM7SUFDVCxPQUFPLENBQ04sS0FBK0IsRUFDL0IsZUFBZSxHQUFHLHVCQUF1QixFQUN4QyxFQUFFO1FBQ0gsSUFBSSxRQUFrQixDQUFDO1FBQ3ZCLElBQUksT0FBTyxLQUFLLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDbEMsNkNBQTZDO1lBQzdDLE1BQU0sT0FBTyxHQUNaLE9BQU8sS0FBSyxLQUFLLFVB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TDtRQUNsRCxLQUFLO1FBQ0wsR0FBRyxFQUFFLENBQUMsRUFBRTtLQUNSLENBQUM7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLHdCQUF3QixDQVd0QyxXQUFtQixFQUFFLE9BQWtCO0lBR3hDLE1BQU0sS0FBSyxHQUNULE9BQXVELEVBQUUsS0FBSztRQUMvRCxJQUFJLGNBQWMsQ0FBVSxXQUFXLENBQUMsQ0FBQztJQUMxQyxPQUFPO1FBQ04sY0FBYyxDQUFDLEtBQUssQ0FBaUQ7UUFDckUsZUFBZSxDQUNkLEtBQUssRUFDTCxHQUFHLEVBQUUsQ0FBQyxJQUFLLEVBQ1gsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUEyQyxDQUNUO1FBQ2pELEtBQUs7UUFDTCxHQUFHLEVBQUUsQ0FBQyxFQUFFO0tBQ3FDLENBQUM7QUFDaEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEVOVklST05NRU5UX0lOSVRJQUxJWkVSLFxuXHRJbmplY3Rpb25Ub2tlbixcblx0aW5qZWN0LFxuXHRydW5JbkluamVjdGlvbkNvbnRleHQsXG5cdHR5cGUgRW52aXJvbm1lbnRQcm92aWRlcnMsXG5cdHR5cGUgRmFjdG9yeVByb3ZpZGVyLFxuXHR0eXBlIEhvc3QsXG5cdHR5cGUgSW5qZWN0T3B0aW9ucyxcblx0dHlwZSBJbmplY3Rvcixcblx0dHlwZSBPcHRpb25hbCxcblx0dHlwZSBQcm92aWRlcixcblx0dHlwZSBTZWxmLFxuXHR0eXBlIFNraXBTZWxmLFxuXHR0eXBlIFR5cGUsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYXNzZXJ0SW5qZWN0b3IgfSBmcm9tICduZ3h0ZW5zaW9uL2Fzc2VydC1pbmplY3Rvcic7XG5cbnR5cGUgQ3JlYXRlSW5qZWN0aW9uVG9rZW5EZXA8VFRva2VuVHlwZT4gPVxuXHR8IFR5cGU8VFRva2VuVHlwZT5cblx0Ly8gTk9URTogd2UgZG9uJ3QgaGF2ZSBhbiBBYnN0cmFjdFR5cGVcblx0fCAoYWJzdHJhY3QgbmV3ICguLi5hcmdzOiBhbnlbXSkgPT4gVFRva2VuVHlwZSlcblx0fCBJbmplY3Rpb25Ub2tlbjxUVG9rZW5UeXBlPjtcblxudHlwZSBDcmVhdGVJbmplY3Rpb25Ub2tlbkRlcHM8XG5cdFRGYWN0b3J5IGV4dGVuZHMgKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnksXG5cdFRGYWN0b3J5RGVwcyBleHRlbmRzIFBhcmFtZXRlcnM8VEZhY3Rvcnk+ID0gUGFyYW1ldGVyczxURmFjdG9yeT4sXG4+ID0ge1xuXHRbSW5kZXggaW4ga2V5b2YgVEZhY3RvcnlEZXBzXTpcblx0XHR8IENyZWF0ZUluamVjdGlvblRva2VuRGVwPFRGYWN0b3J5RGVwc1tJbmRleF0+XG5cdFx0fCBbXG5cdFx0XHRcdC4uLm1vZGlmaWVyczogQXJyYXk8T3B0aW9uYWwgfCBTZWxmIHwgU2tpcFNlbGYgfCBIb3N0Pixcblx0XHRcdFx0dG9rZW46IENyZWF0ZUluamVjdGlvblRva2VuRGVwPFRGYWN0b3J5RGVwc1tJbmRleF0+LFxuXHRcdCAgXTtcbn0gJiB7IGxlbmd0aDogVEZhY3RvcnlEZXBzWydsZW5ndGgnXSB9O1xuXG5leHBvcnQgdHlwZSBDcmVhdGVJbmplY3Rpb25Ub2tlbk9wdGlvbnM8XG5cdFRGYWN0b3J5IGV4dGVuZHMgKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnksXG5cdFRGYWN0b3J5RGVwcyBleHRlbmRzIFBhcmFtZXRlcnM8VEZhY3Rvcnk+ID0gUGFyYW1ldGVyczxURmFjdG9yeT4sXG4+ID1cblx0Ly8gdGhpcyBtZWFucyBURnVuY3Rpb24gaGFzIG5vIHBhcmFtZXRlcnNcblx0KFRGYWN0b3J5RGVwc1swXSBleHRlbmRzIHVuZGVmaW5lZFxuXHRcdD8geyBkZXBzPzogbmV2ZXIgfVxuXHRcdDogeyBkZXBzOiBDcmVhdGVJbmplY3Rpb25Ub2tlbkRlcHM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4gfSkgJiB7XG5cdFx0aXNSb290PzogYm9vbGVhbjtcblx0XHRpc0Z1bmN0aW9uVmFsdWU/OiBib29sZWFuO1xuXHRcdG11bHRpPzogYm9vbGVhbjtcblx0XHR0b2tlbj86IEluamVjdGlvblRva2VuPFJldHVyblR5cGU8VEZhY3Rvcnk+Pjtcblx0XHRleHRyYVByb3ZpZGVycz86IFByb3ZpZGVyIHwgRW52aXJvbm1lbnRQcm92aWRlcnM7XG5cdH07XG5cbnR5cGUgQ3JlYXRlUHJvdmlkZUZuT3B0aW9uczxcblx0VEZhY3RvcnkgZXh0ZW5kcyAoLi4uYXJnczogYW55W10pID0+IGFueSxcblx0VEZhY3RvcnlEZXBzIGV4dGVuZHMgUGFyYW1ldGVyczxURmFjdG9yeT4gPSBQYXJhbWV0ZXJzPFRGYWN0b3J5Pixcbj4gPSBQaWNrPFxuXHRDcmVhdGVJbmplY3Rpb25Ub2tlbk9wdGlvbnM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4sXG5cdCdkZXBzJyB8ICdleHRyYVByb3ZpZGVycycgfCAnbXVsdGknIHwgJ2lzRnVuY3Rpb25WYWx1ZSdcbj47XG5cbnR5cGUgSW5qZWN0Rm48VEZhY3RvcnlSZXR1cm4+ID0ge1xuXHQoKTogVEZhY3RvcnlSZXR1cm47XG5cdChcblx0XHRpbmplY3RPcHRpb25zOiBJbmplY3RPcHRpb25zICYgeyBvcHRpb25hbD86IGZhbHNlIH0gJiB7XG5cdFx0XHRpbmplY3Rvcj86IEluamVjdG9yO1xuXHRcdH0sXG5cdCk6IFRGYWN0b3J5UmV0dXJuO1xuXHQoXG5cdFx0aW5qZWN0T3B0aW9uczogSW5qZWN0T3B0aW9ucyAmIHsgaW5qZWN0b3I/OiBJbmplY3RvciB9LFxuXHQpOiBURmFjdG9yeVJldHVybiB8IG51bGw7XG59O1xuXG50eXBlIFByb3ZpZGVGbjxcblx0VE5vb3AgZXh0ZW5kcyBib29sZWFuLFxuXHRURmFjdG9yeVJldHVybixcblx0VFJldHVybiA9IFRGYWN0b3J5UmV0dXJuIGV4dGVuZHMgQXJyYXk8aW5mZXIgSXRlbT4gPyBJdGVtIDogVEZhY3RvcnlSZXR1cm4sXG4+ID0gKFROb29wIGV4dGVuZHMgdHJ1ZVxuXHQ/ICh2YWx1ZTogVFJldHVybiB8ICgoKSA9PiBUUmV0dXJuKSkgPT4gUHJvdmlkZXJcblx0OiAoKSA9PiBQcm92aWRlcikgJlxuXHQoVFJldHVybiBleHRlbmRzIEZ1bmN0aW9uXG5cdFx0PyAodmFsdWU6IFRSZXR1cm4gfCAoKCkgPT4gVFJldHVybiksIGlzRnVuY3Rpb25WYWx1ZTogYm9vbGVhbikgPT4gUHJvdmlkZXJcblx0XHQ6ICh2YWx1ZTogVFJldHVybiB8ICgoKSA9PiBUUmV0dXJuKSkgPT4gUHJvdmlkZXIpO1xuXG5leHBvcnQgdHlwZSBDcmVhdGVJbmplY3Rpb25Ub2tlblJldHVybjxcblx0VEZhY3RvcnlSZXR1cm4sXG5cdFROb29wIGV4dGVuZHMgYm9vbGVhbiA9IGZhbHNlLFxuPiA9IFtcblx0SW5qZWN0Rm48VEZhY3RvcnlSZXR1cm4+LFxuXHRQcm92aWRlRm48VE5vb3AsIFRGYWN0b3J5UmV0dXJuPixcblx0SW5qZWN0aW9uVG9rZW48VEZhY3RvcnlSZXR1cm4+LFxuXHQoKSA9PiBQcm92aWRlcixcbl07XG5cbmZ1bmN0aW9uIGNyZWF0ZUluamVjdEZuPFRWYWx1ZT4odG9rZW46IEluamVjdGlvblRva2VuPFRWYWx1ZT4pIHtcblx0cmV0dXJuIGZ1bmN0aW9uIChcblx0XHR0aGlzOiBGdW5jdGlvbixcblx0XHR7XG5cdFx0XHRpbmplY3Rvcixcblx0XHRcdC4uLmluamVjdE9wdGlvbnNcblx0XHR9OiBJbmplY3RPcHRpb25zICYgeyBpbmplY3Rvcj86IEluamVjdG9yIH0gPSB7fSxcblx0KSB7XG5cdFx0aW5qZWN0b3IgPSBhc3NlcnRJbmplY3Rvcih0aGlzLCBpbmplY3Rvcik7XG5cdFx0cmV0dXJuIHJ1bkluSW5qZWN0aW9uQ29udGV4dChpbmplY3RvciwgKCkgPT5cblx0XHRcdGluamVjdCh0b2tlbiwgaW5qZWN0T3B0aW9ucyBhcyBJbmplY3RPcHRpb25zKSxcblx0XHQpO1xuXHR9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVQcm92aWRlRm48XG5cdFRWYWx1ZSxcblx0VEZhY3RvcnkgZXh0ZW5kcyAoLi4uYXJnczogYW55W10pID0+IGFueSA9ICguLi5hcmdzOiBhbnlbXSkgPT4gVFZhbHVlLFxuXHRURmFjdG9yeURlcHMgZXh0ZW5kcyBQYXJhbWV0ZXJzPFRGYWN0b3J5PiA9IFBhcmFtZXRlcnM8VEZhY3Rvcnk+LFxuPihcblx0dG9rZW46IEluamVjdGlvblRva2VuPFRWYWx1ZT4sXG5cdGZhY3Rvcnk6ICguLi5hcmdzOiBhbnlbXSkgPT4gVFZhbHVlLFxuXHRvcHRzOiBDcmVhdGVQcm92aWRlRm5PcHRpb25zPFRGYWN0b3J5LCBURmFjdG9yeURlcHM+ID0ge30sXG4pIHtcblx0Y29uc3Qge1xuXHRcdGRlcHMgPSBbXSxcblx0XHRtdWx0aSA9IGZhbHNlLFxuXHRcdGV4dHJhUHJvdmlkZXJzID0gW10sXG5cdFx0aXNGdW5jdGlvblZhbHVlOiBpc0Z1bmN0aW9uVmFsdWVGcm9tT3B0cyA9IGZhbHNlLFxuXHR9ID0gb3B0cztcblx0cmV0dXJuIChcblx0XHR2YWx1ZT86IFRWYWx1ZSB8ICgoKSA9PiBUVmFsdWUpLFxuXHRcdGlzRnVuY3Rpb25WYWx1ZSA9IGlzRnVuY3Rpb25WYWx1ZUZyb21PcHRzLFxuXHQpID0+IHtcblx0XHRsZXQgcHJvdmlkZXI6IFByb3ZpZGVyO1xuXHRcdGlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHQvLyBUT0RPOiAoY2hhdSkgbWF5YmUgdGhpcyBjYW4gYmUgbWFkZSBiZXR0ZXJcblx0XHRcdGNvbnN0IGZhY3RvcnkgPVxuXHRcdFx0XHR0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbidcblx0XHRcdFx0XHQ/IGlzRnVuY3Rpb25WYWx1ZVxuXHRcdFx0XHRcdFx0PyAoKSA9PiB2YWx1ZVxuXHRcdFx0XHRcdFx0OiB2YWx1ZVxuXHRcdFx0XHRcdDogKCkgPT4gdmFsdWU7XG5cblx0XHRcdHByb3ZpZGVyID0ge1xuXHRcdFx0XHRwcm92aWRlOiB0b2tlbixcblx0XHRcdFx0dXNlRmFjdG9yeTogZmFjdG9yeSxcblx0XHRcdFx0bXVsdGksXG5cdFx0XHR9O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRwcm92aWRlciA9IHtcblx0XHRcdFx0cHJvdmlkZTogdG9rZW4sXG5cdFx0XHRcdHVzZUZhY3Rvcnk6IGZhY3RvcnksXG5cdFx0XHRcdGRlcHM6IGRlcHMgYXMgRmFjdG9yeVByb3ZpZGVyWydkZXBzJ10sXG5cdFx0XHRcdG11bHRpLFxuXHRcdFx0fTtcblx0XHR9XG5cblx0XHRyZXR1cm4gW2V4dHJhUHJvdmlkZXJzLCBwcm92aWRlcl07XG5cdH07XG59XG5cbi8qKlxuICogYGNyZWF0ZUluamVjdGlvblRva2VuYCBhY2NlcHRzIGEgZmFjdG9yeSBmdW5jdGlvbiBhbmQgcmV0dXJucyBhIHR1cGxlIG9mIGBpbmplY3RGbmAsIGBwcm92aWRlRm5gLCBhbmQgdGhlIGBJbmplY3Rpb25Ub2tlbmBcbiAqIHRoYXQgdGhlIGZhY3RvcnkgZnVuY3Rpb24gaXMgZm9yLlxuICpcbiAqIEBwYXJhbSB7RnVuY3Rpb259IGZhY3RvcnkgLSBGYWN0b3J5IEZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgdmFsdWUgZm9yIHRoZSBgSW5qZWN0aW9uVG9rZW5gXG4gKiBAcGFyYW0ge0NyZWF0ZUluamVjdGlvblRva2VuT3B0aW9uc30gb3B0aW9ucyAtIG9iamVjdCB0byBjb250cm9sIGhvdyB0aGUgYEluamVjdGlvblRva2VuYCBiZWhhdmVzXG4gKiBAcmV0dXJucyB7Q3JlYXRlSW5qZWN0aW9uVG9rZW5SZXR1cm59XG4gKlxuICogQGV4YW1wbGVcbiAqIGBgYHRzXG4gKiBjb25zdCBbaW5qZWN0Q291bnRlciwgcHJvdmlkZUNvdW50ZXIsIENPVU5URVJdID0gY3JlYXRlSW5qZWN0aW9uVG9rZW4oKCkgPT4gc2lnbmFsKDApKTtcbiAqXG4gKiBleHBvcnQgY2xhc3MgQ291bnRlciB7XG4gKiAgY291bnRlciA9IGluamVjdENvdW50ZXIoKTsgLy8gV3JpdGFibGVTaWduYWw8bnVtYmVyPlxuICogfVxuICogYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbmplY3Rpb25Ub2tlbjxcblx0VEZhY3RvcnkgZXh0ZW5kcyAoLi4uYXJnczogYW55W10pID0+IGFueSxcblx0VEZhY3RvcnlEZXBzIGV4dGVuZHMgUGFyYW1ldGVyczxURmFjdG9yeT4gPSBQYXJhbWV0ZXJzPFRGYWN0b3J5Pixcblx0VE9wdGlvbnMgZXh0ZW5kcyBDcmVhdGVJbmplY3Rpb25Ub2tlbk9wdGlvbnM8XG5cdFx0VEZhY3RvcnksXG5cdFx0VEZhY3RvcnlEZXBzXG5cdD4gPSBDcmVhdGVJbmplY3Rpb25Ub2tlbk9wdGlvbnM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4sXG5cdFRGYWN0b3J5UmV0dXJuID0gVE9wdGlvbnNbJ211bHRpJ10gZXh0ZW5kcyB0cnVlXG5cdFx0PyBBcnJheTxSZXR1cm5UeXBlPFRGYWN0b3J5Pj5cblx0XHQ6IFJldHVyblR5cGU8VEZhY3Rvcnk+LFxuPihcblx0ZmFjdG9yeTogVEZhY3RvcnksXG5cdG9wdGlvbnM/OiBUT3B0aW9ucyxcbik6IENyZWF0ZUluamVjdGlvblRva2VuUmV0dXJuPFRGYWN0b3J5UmV0dXJuPiB7XG5cdGNvbnN0IHRva2VuTmFtZSA9IGZhY3RvcnkubmFtZSB8fCBmYWN0b3J5LnRvU3RyaW5nKCk7XG5cdGNvbnN0IG9wdHMgPVxuXHRcdG9wdGlvbnMgPz9cblx0XHQoeyBpc1Jvb3Q6IHRydWUgfSBhcyBDcmVhdGVJbmplY3Rpb25Ub2tlbk9wdGlvbnM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4pO1xuXG5cdG9wdHMuaXNSb290ID8/PSB0cnVlO1xuXG5cdC8vIE5PVEU6IG11bHRpIHRva2VucyBjYW5ub3QgYmUgYSByb290IHRva2VuLiBJdCBoYXMgdG8gYmUgcHJvdmlkZWQgKHByb3ZpZGVGbiBuZWVkcyB0byBiZSBpbnZva2VkKVxuXHQvLyBmb3IgdGhlICdtdWx0aScgZmxhZyB0byB3b3JrIHByb3Blcmx5XG5cdGlmIChvcHRzLm11bHRpKSB7XG5cdFx0b3B0cy5pc1Jvb3QgPSBmYWxzZTtcblx0fVxuXG5cdGlmIChvcHRzLmlzUm9vdCkge1xuXHRcdGlmIChvcHRzLnRva2VuKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFxcXG5jcmVhdGVJbmplY3Rpb25Ub2tlbiBpcyBjcmVhdGluZyBhIHJvb3QgSW5qZWN0aW9uVG9rZW4gYnV0IGFuIGV4dGVybmFsIHRva2VuIGlzIHBhc3NlZCBpbi5cbmApO1xuXHRcdH1cblxuXHRcdGNvbnN0IHRva2VuID0gbmV3IEluamVjdGlvblRva2VuPFRGYWN0b3J5UmV0dXJuPihgVG9rZW4gZm9yICR7dG9rZW5OYW1lfWAsIHtcblx0XHRcdGZhY3Rvcnk6ICgpID0+IHtcblx0XHRcdFx0aWYgKG9wdHMuZGVwcyAmJiBBcnJheS5pc0FycmF5KG9wdHMuZGVwcykpIHtcblx0XHRcdFx0XHRyZXR1cm4gZmFjdG9yeShcblx0XHRcdFx0XHRcdC4uLm9wdHMuZGVwcy5tYXAoKGRlcCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRkZXAgPSAoXG5cdFx0XHRcdFx0XHRcdFx0QXJyYXkuaXNBcnJheShkZXApID8gZGVwLmF0KC0xKSA6IGRlcFxuXHRcdFx0XHRcdFx0XHQpIGFzIENyZWF0ZUluamVjdGlvblRva2VuRGVwPGFueT47XG5cdFx0XHRcdFx0XHRcdHJldHVybiBpbmplY3QoZGVwKTtcblx0XHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIGZhY3RvcnkoKTtcblx0XHRcdH0sXG5cdFx0fSk7XG5cblx0XHRjb25zdCBpbmplY3RGbiA9IGNyZWF0ZUluamVjdEZuKFxuXHRcdFx0dG9rZW4sXG5cdFx0KSBhcyBDcmVhdGVJbmplY3Rpb25Ub2tlblJldHVybjxURmFjdG9yeVJldHVybj5bMF07XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0aW5qZWN0Rm4sXG5cdFx0XHRjcmVhdGVQcm92aWRlRm4oXG5cdFx0XHRcdHRva2VuLFxuXHRcdFx0XHRmYWN0b3J5LFxuXHRcdFx0XHRvcHRzIGFzIENyZWF0ZVByb3ZpZGVGbk9wdGlvbnM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4sXG5cdFx0XHQpIGFzIENyZWF0ZUluamVjdGlvblRva2VuUmV0dXJuPFRGYWN0b3J5UmV0dXJuPlsxXSxcblx0XHRcdHRva2VuLFxuXHRcdFx0KCkgPT4gKHtcblx0XHRcdFx0cHJvdmlkZTogRU5WSVJPTk1FTlRfSU5JVElBTElaRVIsXG5cdFx0XHRcdHVzZVZhbHVlOiAoKSA9PiBpbmplY3RGbigpLFxuXHRcdFx0XHRtdWx0aTogdHJ1ZSxcblx0XHRcdH0pLFxuXHRcdF07XG5cdH1cblxuXHRjb25zdCB0b2tlbiA9XG5cdFx0b3B0cy50b2tlbiB8fCBuZXcgSW5qZWN0aW9uVG9rZW48VEZhY3RvcnlSZXR1cm4+KGBUb2tlbiBmb3IgJHt0b2tlbk5hbWV9YCk7XG5cdHJldHVybiBbXG5cdFx0Y3JlYXRlSW5qZWN0Rm4odG9rZW4pIGFzIENyZWF0ZUluamVjdGlvblRva2VuUmV0dXJuPFRGYWN0b3J5UmV0dXJuPlswXSxcblx0XHRjcmVhdGVQcm92aWRlRm4oXG5cdFx0XHR0b2tlbixcblx0XHRcdGZhY3RvcnksXG5cdFx0XHRvcHRzIGFzIENyZWF0ZVByb3ZpZGVGbk9wdGlvbnM8VEZhY3RvcnksIFRGYWN0b3J5RGVwcz4sXG5cdFx0KSBhcyBDcmVhdGVJbmplY3Rpb25Ub2tlblJldHVybjxURmFjdG9yeVJldHVybj5bMV0sXG5cdFx0dG9rZW4sXG5cdFx0KCkgPT4gW10sXG5cdF07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVOb29wSW5qZWN0aW9uVG9rZW48XG5cdFRWYWx1ZSxcblx0VE11bHRpIGV4dGVuZHMgYm9vbGVhbiA9IGZhbHNlLFxuXHRUT3B0aW9ucyA9IFBpY2s8XG5cdFx0Q3JlYXRlSW5qZWN0aW9uVG9rZW5PcHRpb25zPCgpID0+IHZvaWQsIFtdPixcblx0XHQnZXh0cmFQcm92aWRlcnMnXG5cdD4gJlxuXHRcdChUVmFsdWUgZXh0ZW5kcyAoLi4uYXJnczogYW55W10pID0+IGFueVxuXHRcdFx0PyB7IGlzRnVuY3Rpb25WYWx1ZTogdHJ1ZSB9XG5cdFx0XHQ6IHsgaXNGdW5jdGlvblZhbHVlPzogbmV2ZXIgfSkgJlxuXHRcdChUTXVsdGkgZXh0ZW5kcyB0cnVlID8geyBtdWx0aTogdHJ1ZSB9IDogeyBtdWx0aT86IG5ldmVyIH0pLFxuPihkZXNjcmlwdGlvbjogc3RyaW5nLCBvcHRpb25zPzogVE9wdGlvbnMpIHtcblx0dHlwZSBUUmV0dXJuID0gVE11bHRpIGV4dGVuZHMgdHJ1ZSA/IEFycmF5PFRWYWx1ZT4gOiBUVmFsdWU7XG5cblx0Y29uc3QgdG9rZW4gPVxuXHRcdChvcHRpb25zIGFzIENyZWF0ZUluamVjdGlvblRva2VuT3B0aW9uczwoKSA9PiB2b2lkLCBbXT4pPy50b2tlbiB8fFxuXHRcdG5ldyBJbmplY3Rpb25Ub2tlbjxUUmV0dXJuPihkZXNjcmlwdGlvbik7XG5cdHJldHVybiBbXG5cdFx0Y3JlYXRlSW5qZWN0Rm4odG9rZW4pIGFzIENyZWF0ZUluamVjdGlvblRva2VuUmV0dXJuPFRSZXR1cm4sIHRydWU+WzBdLFxuXHRcdGNyZWF0ZVByb3ZpZGVGbihcblx0XHRcdHRva2VuLFxuXHRcdFx0KCkgPT4gbnVsbCEsXG5cdFx0XHQob3B0aW9ucyB8fCB7fSkgYXMgQ3JlYXRlUHJvdmlkZUZuT3B0aW9uczwoKSA9PiB2b2lkLCBbXT4sXG5cdFx0KSBhcyBDcmVhdGVJbmplY3Rpb25Ub2tlblJldHVybjxUUmV0dXJuLCB0cnVlPlsxXSxcblx0XHR0b2tlbixcblx0XHQoKSA9PiBbXSxcblx0XSBhcyBDcmVhdGVJbmplY3Rpb25Ub2tlblJldHVybjxUUmV0dXJuLCB0cnVlPjtcbn1cbiJdfQ==