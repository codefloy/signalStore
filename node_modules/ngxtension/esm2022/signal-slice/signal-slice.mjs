import { DestroyRef, Injector, computed, effect, inject, signal, } from '@angular/core';
import { takeUntilDestroyed, toObservable } from '@angular/core/rxjs-interop';
import { connect } from 'ngxtension/connect';
import { Subject, isObservable, share, take } from 'rxjs';
export function signalSlice(config) {
    const destroyRef = inject(DestroyRef);
    const injector = inject(Injector);
    const { initialState, sources = [], lazySources = [], actionSources = {}, selectors = (() => ({})), effects = (() => ({})), } = config;
    const state = signal(initialState);
    const readonlyState = state.asReadonly();
    const state$ = toObservable(state);
    let lazySourcesLoaded = false;
    const subs = [];
    const slice = readonlyState;
    connectSources(state, sources);
    for (const [key, actionSource] of Object.entries(actionSources)) {
        if (isObservable(actionSource)) {
            addReducerProperties(readonlyState, state$, key, destroyRef, actionSource, subs);
        }
        else {
            const subject = new Subject();
            const observable = actionSource(readonlyState, subject);
            const sharedObservable = observable.pipe(share());
            connect(state, sharedObservable);
            addReducerProperties(readonlyState, state$, key, destroyRef, subject, subs, sharedObservable);
        }
    }
    for (const key in initialState) {
        Object.defineProperty(readonlyState, key, {
            value: computed(() => readonlyState()[key]),
        });
    }
    for (const [key, selector] of Object.entries(selectors(slice))) {
        Object.defineProperty(readonlyState, key, {
            value: computed(selector),
        });
    }
    for (const [key, namedEffect] of Object.entries(effects(slice))) {
        console.warn("The 'effects' configuration in signalSlice is deprecated. Please use standard signal effects outside of signalSlice instead.");
        Object.defineProperty(slice, key, {
            value: effect((onCleanup) => {
                const maybeCleanup = namedEffect();
                if (maybeCleanup) {
                    onCleanup(() => maybeCleanup());
                }
            }),
        });
    }
    destroyRef.onDestroy(() => {
        subs.forEach((sub) => sub.complete());
    });
    const connectLazySources = () => {
        if (!lazySourcesLoaded) {
            lazySourcesLoaded = true;
            connectSources(state, lazySources, injector, true);
        }
    };
    return new Proxy(slice, {
        get(target, property, receiver) {
            connectLazySources();
            return Reflect.get(target, property, receiver);
        },
        apply(target, thisArg, argumentsList) {
            connectLazySources();
            return Reflect.apply(target, thisArg, argumentsList);
        },
    });
}
function connectSources(state, sources, injector, useUntracked = false) {
    for (const source of sources) {
        if (isObservable(source)) {
            connect(state, source, injector, useUntracked);
        }
        else {
            connect(state, source(state.asReadonly()), injector, useUntracked);
        }
    }
}
function addReducerProperties(readonlyState, state$, key, destroyRef, subject, subs, observableFromActionSource) {
    Object.defineProperties(readonlyState, {
        [key]: {
            value: (nextValue) => {
                if (isObservable(nextValue)) {
                    return new Promise((res, rej) => {
                        nextValue.pipe(takeUntilDestroyed(destroyRef)).subscribe({
                            next: (value) => {
                                subject.next(value);
                            },
                            error: (err) => {
                                subject.error(err);
                                rej(err);
                            },
                            complete: () => {
                                subject.complete();
                                res(readonlyState());
                            },
                        });
                    });
                }
                if (observableFromActionSource) {
                    observableFromActionSource
                        .pipe(takeUntilDestroyed(destroyRef))
                        .subscribe();
                }
                return new Promise((res) => {
                    state$.pipe(take(1)).subscribe((val) => {
                        res(val);
                    });
                    subject.next(nextValue);
                });
            },
        },
        [`${key}$`]: {
            value: subject.asObservable(),
        },
    });
    subs.push(subject);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbmFsLXNsaWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3h0ZW5zaW9uL3NpZ25hbC1zbGljZS9zcmMvc2lnbmFsLXNsaWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixVQUFVLEVBQ1YsUUFBUSxFQUNSLFFBQVEsRUFDUixNQUFNLEVBQ04sTUFBTSxFQUNOLE1BQU0sR0FJTixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUUsT0FBTyxFQUFFLE9BQU8sRUFBcUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRixPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFtQixNQUFNLE1BQU0sQ0FBQztBQTBHM0UsTUFBTSxVQUFVLFdBQVcsQ0FLekIsTUFVRDtJQUNBLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN0QyxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFbEMsTUFBTSxFQUNMLFlBQVksRUFDWixPQUFPLEdBQUcsRUFBRSxFQUNaLFdBQVcsR0FBRyxFQUFFLEVBQ2hCLGFBQWEsR0FBRyxFQUFFLEVBQ2xCLFNBQVMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBR3RCLEVBQ0QsT0FBTyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FHcEIsR0FDRCxHQUFHLE1BQU0sQ0FBQztJQUVYLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNuQyxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDekMsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25DLElB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QUNEO1FBQ0QsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEVBQUU7WUFDWixLQUFLLEVBQUUsT0FBTyxDQUFDLFlBQVksRUFBRTtTQUM3QjtLQUNELENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdERlc3Ryb3lSZWYsXG5cdEluamVjdG9yLFxuXHRjb21wdXRlZCxcblx0ZWZmZWN0LFxuXHRpbmplY3QsXG5cdHNpZ25hbCxcblx0dHlwZSBFZmZlY3RSZWYsXG5cdHR5cGUgU2lnbmFsLFxuXHR0eXBlIFdyaXRhYmxlU2lnbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHRha2VVbnRpbERlc3Ryb3llZCwgdG9PYnNlcnZhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZS9yeGpzLWludGVyb3AnO1xuaW1wb3J0IHsgY29ubmVjdCwgdHlwZSBQYXJ0aWFsT3JWYWx1ZSwgdHlwZSBSZWR1Y2VyIH0gZnJvbSAnbmd4dGVuc2lvbi9jb25uZWN0JztcbmltcG9ydCB7IFN1YmplY3QsIGlzT2JzZXJ2YWJsZSwgc2hhcmUsIHRha2UsIHR5cGUgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG50eXBlIEFjdGlvblNvdXJjZUZuPFRTaWduYWxWYWx1ZSwgVFBheWxvYWQ+ID0gKFxuXHRzdGF0ZTogU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdHZhbHVlOiBUUGF5bG9hZCxcbikgPT4gT2JzZXJ2YWJsZTxQYXJ0aWFsT3JWYWx1ZTxUU2lnbmFsVmFsdWU+PjtcblxudHlwZSBOb09wdGlvbmFsUHJvcGVydGllczxUPiA9IHtcblx0W1AgaW4ga2V5b2YgVF0tPzogVFtQXTtcbn07XG5cbnR5cGUgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT4gPSB7XG5cdFthY3Rpb25OYW1lOiBzdHJpbmddOiBTdWJqZWN0PGFueT4gfCBBY3Rpb25Tb3VyY2VGbjxUU2lnbmFsVmFsdWUsIGFueT47XG59O1xuXG50eXBlIE5hbWVkU2VsZWN0b3JzID0ge1xuXHRbc2VsZWN0b3JOYW1lOiBzdHJpbmddOiAoKSA9PiBhbnk7XG59O1xuXG50eXBlIFNlbGVjdG9yczxUU2lnbmFsVmFsdWU+ID0ge1xuXHRbSyBpbiBrZXlvZiBUU2lnbmFsVmFsdWVdOiBTaWduYWw8VFNpZ25hbFZhbHVlW0tdPjtcbn07XG5cbnR5cGUgRXh0cmFTZWxlY3RvcnM8VFNlbGVjdG9ycyBleHRlbmRzIE5hbWVkU2VsZWN0b3JzPiA9IHtcblx0W0sgaW4ga2V5b2YgVFNlbGVjdG9yc106IFNpZ25hbDxSZXR1cm5UeXBlPFRTZWxlY3RvcnNbS10+Pjtcbn07XG5cbnR5cGUgTmFtZWRFZmZlY3RzID0ge1xuXHRbc2VsZWN0b3JOYW1lOiBzdHJpbmddOiAoKSA9PiB2b2lkIHwgKCgpID0+IHZvaWQpO1xufTtcblxudHlwZSBFZmZlY3RzPFRFZmZlY3RzIGV4dGVuZHMgTmFtZWRFZmZlY3RzPiA9IHtcblx0W0sgaW4ga2V5b2YgVEVmZmVjdHNdOiBFZmZlY3RSZWY7XG59O1xuXG50eXBlIEFjdGlvbjxUU2lnbmFsVmFsdWUsIFRWYWx1ZT4gPSBUVmFsdWUgZXh0ZW5kcyBbdm9pZF1cblx0PyAoKSA9PiBQcm9taXNlPFRTaWduYWxWYWx1ZT5cblx0OiBbdW5rbm93bl0gZXh0ZW5kcyBUVmFsdWVcblx0XHQ/ICgpID0+IFByb21pc2U8VFNpZ25hbFZhbHVlPlxuXHRcdDogKFxuXHRcdFx0XHR2YWx1ZTogVFZhbHVlIGV4dGVuZHMgW2luZmVyIFRJbmZlcnJlZF1cblx0XHRcdFx0XHQ/IFRJbmZlcnJlZCB8IE9ic2VydmFibGU8VEluZmVycmVkPlxuXHRcdFx0XHRcdDogVFZhbHVlIHwgT2JzZXJ2YWJsZTxUVmFsdWU+LFxuXHRcdFx0KSA9PiBQcm9taXNlPFRTaWduYWxWYWx1ZT47XG5cbnR5cGUgQWN0aW9uTWV0aG9kPFxuXHRUU2lnbmFsVmFsdWUsXG5cdFRBY3Rpb25Tb3VyY2UgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPltzdHJpbmddLFxuPiA9IFRBY3Rpb25Tb3VyY2UgZXh0ZW5kcyAoXG5cdHN0YXRlOiBTaWduYWw8VFNpZ25hbFZhbHVlPixcblx0dmFsdWU6IE9ic2VydmFibGU8aW5mZXIgVE9ic2VydmFibGVWYWx1ZT4sXG4pID0+IGFueVxuXHQ/IEFjdGlvbjxUU2lnbmFsVmFsdWUsIFtUT2JzZXJ2YWJsZVZhbHVlXT5cblx0OiBUQWN0aW9uU291cmNlIGV4dGVuZHMgU3ViamVjdDxpbmZlciBUU3ViamVjdFZhbHVlPlxuXHRcdD8gQWN0aW9uPFRTaWduYWxWYWx1ZSwgW1RTdWJqZWN0VmFsdWVdPlxuXHRcdDogbmV2ZXI7XG5cbnR5cGUgQWN0aW9uTWV0aG9kczxcblx0VFNpZ25hbFZhbHVlLFxuXHRUQWN0aW9uU291cmNlcyBleHRlbmRzIE5hbWVkQWN0aW9uU291cmNlczxUU2lnbmFsVmFsdWU+LFxuPiA9IHtcblx0W0sgaW4ga2V5b2YgVEFjdGlvblNvdXJjZXNdOiBBY3Rpb25NZXRob2Q8VFNpZ25hbFZhbHVlLCBUQWN0aW9uU291cmNlc1tLXT47XG59O1xuXG50eXBlIEFjdGlvblN0cmVhbXM8XG5cdFRTaWduYWxWYWx1ZSxcblx0VEFjdGlvblNvdXJjZXMgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPixcbj4gPSB7XG5cdFtLIGluIGtleW9mIFRBY3Rpb25Tb3VyY2VzICZcblx0XHRzdHJpbmcgYXMgYCR7S30kYF06IFRBY3Rpb25Tb3VyY2VzW0tdIGV4dGVuZHMgUmVkdWNlcjxUU2lnbmFsVmFsdWUsIHVua25vd24+XG5cdFx0PyBPYnNlcnZhYmxlPHZvaWQ+XG5cdFx0OiBUQWN0aW9uU291cmNlc1tLXSBleHRlbmRzIFJlZHVjZXI8VFNpZ25hbFZhbHVlLCBpbmZlciBUVmFsdWU+XG5cdFx0XHQ/IFRWYWx1ZSBleHRlbmRzIE9ic2VydmFibGU8YW55PlxuXHRcdFx0XHQ/IFRWYWx1ZVxuXHRcdFx0XHQ6IE9ic2VydmFibGU8VFZhbHVlPlxuXHRcdFx0OiBuZXZlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFNvdXJjZTxUU2lnbmFsVmFsdWU+ID0gT2JzZXJ2YWJsZTxQYXJ0aWFsT3JWYWx1ZTxUU2lnbmFsVmFsdWU+PjtcbnR5cGUgU291cmNlQ29uZmlnPFRTaWduYWxWYWx1ZT4gPSBBcnJheTxcblx0U291cmNlPFRTaWduYWxWYWx1ZT4gfCAoKHN0YXRlOiBTaWduYWw8VFNpZ25hbFZhbHVlPikgPT4gU291cmNlPFRTaWduYWxWYWx1ZT4pXG4+O1xuXG5leHBvcnQgdHlwZSBTaWduYWxTbGljZTxcblx0VFNpZ25hbFZhbHVlIGV4dGVuZHMgTm9PcHRpb25hbFByb3BlcnRpZXM8VFNpZ25hbFZhbHVlPixcblx0VEFjdGlvblNvdXJjZXMgZXh0ZW5kcyBOYW1lZEFjdGlvblNvdXJjZXM8VFNpZ25hbFZhbHVlPixcblx0VFNlbGVjdG9ycyBleHRlbmRzIE5hbWVkU2VsZWN0b3JzLFxuXHRURWZmZWN0cyBleHRlbmRzIE5hbWVkRWZmZWN0cyxcbj4gPSBTaWduYWw8VFNpZ25hbFZhbHVlPiAmXG5cdFNlbGVjdG9yczxUU2lnbmFsVmFsdWU+ICZcblx0RXh0cmFTZWxlY3RvcnM8VFNlbGVjdG9ycz4gJlxuXHRFZmZlY3RzPFRFZmZlY3RzPiAmXG5cdEFjdGlvbk1ldGhvZHM8VFNpZ25hbFZhbHVlLCBUQWN0aW9uU291cmNlcz4gJlxuXHRBY3Rpb25TdHJlYW1zPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXM+O1xuXG50eXBlIFNlbGVjdG9yc1N0YXRlPFRTaWduYWxWYWx1ZSBleHRlbmRzIE5vT3B0aW9uYWxQcm9wZXJ0aWVzPFRTaWduYWxWYWx1ZT4+ID1cblx0U2lnbmFsPFRTaWduYWxWYWx1ZT4gJiBTZWxlY3RvcnM8VFNpZ25hbFZhbHVlPjtcblxudHlwZSBFZmZlY3RzU3RhdGU8XG5cdFRTaWduYWxWYWx1ZSBleHRlbmRzIE5vT3B0aW9uYWxQcm9wZXJ0aWVzPFRTaWduYWxWYWx1ZT4sXG5cdFRBY3Rpb25Tb3VyY2VzIGV4dGVuZHMgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT4sXG5cdFRTZWxlY3RvcnMgZXh0ZW5kcyBOYW1lZFNlbGVjdG9ycyxcbj4gPSBTZWxlY3RvcnNTdGF0ZTxUU2lnbmFsVmFsdWU+ICZcblx0RXh0cmFTZWxlY3RvcnM8VFNlbGVjdG9ycz4gJlxuXHRBY3Rpb25NZXRob2RzPFRTaWduYWxWYWx1ZSwgVEFjdGlvblNvdXJjZXM+O1xuXG5leHBvcnQgZnVuY3Rpb24gc2lnbmFsU2xpY2U8XG5cdFRTaWduYWxWYWx1ZSBleHRlbmRzIE5vT3B0aW9uYWxQcm9wZXJ0aWVzPFRTaWduYWxWYWx1ZT4sXG5cdFRBY3Rpb25Tb3VyY2VzIGV4dGVuZHMgTmFtZWRBY3Rpb25Tb3VyY2VzPFRTaWduYWxWYWx1ZT4sXG5cdFRTZWxlY3RvcnMgZXh0ZW5kcyBOYW1lZFNlbGVjdG9ycyxcblx0VEVmZmVjdHMgZXh0ZW5kcyBOYW1lZEVmZmVjdHMsXG4+KGNvbmZpZzoge1xuXHRpbml0aWFsU3RhdGU6IFRTaWduYWxWYWx1ZTtcblx0c291cmNlcz86IFNvdXJjZUNvbmZpZzxUU2lnbmFsVmFsdWU+O1xuXHRsYXp5U291cmNlcz86IFNvdXJjZUNvbmZpZzxUU2lnbmFsVmFsdWU+O1xuXHRhY3Rpb25Tb3VyY2VzPzogVEFjdGlvblNvdXJjZXM7XG5cdHNlbGVjdG9ycz86IChzdGF0ZTogU2VsZWN0b3JzU3RhdGU8VFNpZ25hbFZhbHVlPikgPT4gVFNlbGVjdG9ycztcblx0LyoqIEBkZXByZWNhdGVkICovXG5cdGVmZmVjdHM/OiAoXG5cdFx0c3RhdGU6IEVmZmVjdHNTdGF0ZTxUU2lnbmFsVmFsdWUsIFRBY3Rpb25Tb3VyY2VzLCBUU2VsZWN0b3JzPixcblx0KSA9PiBURWZmZWN0cztcbn0pOiBTaWduYWxTbGljZTxUU2lnbmFsVmFsdWUsIFRBY3Rpb25Tb3VyY2VzLCBUU2VsZWN0b3JzLCBURWZmZWN0cz4ge1xuXHRjb25zdCBkZXN0cm95UmVmID0gaW5qZWN0KERlc3Ryb3lSZWYpO1xuXHRjb25zdCBpbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XG5cblx0Y29uc3Qge1xuXHRcdGluaXRpYWxTdGF0ZSxcblx0XHRzb3VyY2VzID0gW10sXG5cdFx0bGF6eVNvdXJjZXMgPSBbXSxcblx0XHRhY3Rpb25Tb3VyY2VzID0ge30sXG5cdFx0c2VsZWN0b3JzID0gKCgpID0+ICh7fSkpIGFzIHVua25vd24gYXMgRXhjbHVkZTxcblx0XHRcdCh0eXBlb2YgY29uZmlnKVsnc2VsZWN0b3JzJ10sXG5cdFx0XHR1bmRlZmluZWRcblx0XHQ+LFxuXHRcdGVmZmVjdHMgPSAoKCkgPT4gKHt9KSkgYXMgdW5rbm93biBhcyBFeGNsdWRlPFxuXHRcdFx0KHR5cGVvZiBjb25maWcpWydlZmZlY3RzJ10sXG5cdFx0XHR1bmRlZmluZWRcblx0XHQ+LFxuXHR9ID0gY29uZmlnO1xuXG5cdGNvbnN0IHN0YXRlID0gc2lnbmFsKGluaXRpYWxTdGF0ZSk7XG5cdGNvbnN0IHJlYWRvbmx5U3RhdGUgPSBzdGF0ZS5hc1JlYWRvbmx5KCk7XG5cdGNvbnN0IHN0YXRlJCA9IHRvT2JzZXJ2YWJsZShzdGF0ZSk7XG5cdGxldCBsYXp5U291cmNlc0xvYWRlZCA9IGZhbHNlO1xuXG5cdGNvbnN0IHN1YnM6IFN1YmplY3Q8YW55PltdID0gW107XG5cblx0Y29uc3Qgc2xpY2UgPSByZWFkb25seVN0YXRlIGFzIFNpZ25hbFNsaWNlPFxuXHRcdFRTaWduYWxWYWx1ZSxcblx0XHRUQWN0aW9uU291cmNlcyxcblx0XHRUU2VsZWN0b3JzLFxuXHRcdFRFZmZlY3RzXG5cdD47XG5cblx0Y29ubmVjdFNvdXJjZXMoc3RhdGUsIHNvdXJjZXMpO1xuXG5cdGZvciAoY29uc3QgW2tleSwgYWN0aW9uU291cmNlXSBvZiBPYmplY3QuZW50cmllcyhcblx0XHRhY3Rpb25Tb3VyY2VzIGFzIFRBY3Rpb25Tb3VyY2VzLFxuXHQpKSB7XG5cdFx0aWYgKGlzT2JzZXJ2YWJsZShhY3Rpb25Tb3VyY2UpKSB7XG5cdFx0XHRhZGRSZWR1Y2VyUHJvcGVydGllcyhcblx0XHRcdFx0cmVhZG9ubHlTdGF0ZSxcblx0XHRcdFx0c3RhdGUkLFxuXHRcdFx0XHRrZXksXG5cdFx0XHRcdGRlc3Ryb3lSZWYsXG5cdFx0XHRcdGFjdGlvblNvdXJjZSxcblx0XHRcdFx0c3Vicyxcblx0XHRcdCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IHN1YmplY3QgPSBuZXcgU3ViamVjdCgpO1xuXHRcdFx0Y29uc3Qgb2JzZXJ2YWJsZSA9IGFjdGlvblNvdXJjZShyZWFkb25seVN0YXRlLCBzdWJqZWN0KTtcblx0XHRcdGNvbnN0IHNoYXJlZE9ic2VydmFibGUgPSBvYnNlcnZhYmxlLnBpcGUoc2hhcmUoKSk7XG5cdFx0XHRjb25uZWN0KHN0YXRlLCBzaGFyZWRPYnNlcnZhYmxlKTtcblx0XHRcdGFkZFJlZHVjZXJQcm9wZXJ0aWVzKFxuXHRcdFx0XHRyZWFkb25seVN0YXRlLFxuXHRcdFx0XHRzdGF0ZSQsXG5cdFx0XHRcdGtleSxcblx0XHRcdFx0ZGVzdHJveVJlZixcblx0XHRcdFx0c3ViamVjdCxcblx0XHRcdFx0c3Vicyxcblx0XHRcdFx0c2hhcmVkT2JzZXJ2YWJsZSxcblx0XHRcdCk7XG5cdFx0fVxuXHR9XG5cblx0Zm9yIChjb25zdCBrZXkgaW4gaW5pdGlhbFN0YXRlKSB7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHJlYWRvbmx5U3RhdGUsIGtleSwge1xuXHRcdFx0dmFsdWU6IGNvbXB1dGVkKCgpID0+IHJlYWRvbmx5U3RhdGUoKVtrZXldKSxcblx0XHR9KTtcblx0fVxuXG5cdGZvciAoY29uc3QgW2tleSwgc2VsZWN0b3JdIG9mIE9iamVjdC5lbnRyaWVzKHNlbGVjdG9ycyhzbGljZSkpKSB7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHJlYWRvbmx5U3RhdGUsIGtleSwge1xuXHRcdFx0dmFsdWU6IGNvbXB1dGVkKHNlbGVjdG9yKSxcblx0XHR9KTtcblx0fVxuXG5cdGZvciAoY29uc3QgW2tleSwgbmFtZWRFZmZlY3RdIG9mIE9iamVjdC5lbnRyaWVzKGVmZmVjdHMoc2xpY2UpKSkge1xuXHRcdGNvbnNvbGUud2Fybihcblx0XHRcdFwiVGhlICdlZmZlY3RzJyBjb25maWd1cmF0aW9uIGluIHNpZ25hbFNsaWNlIGlzIGRlcHJlY2F0ZWQuIFBsZWFzZSB1c2Ugc3RhbmRhcmQgc2lnbmFsIGVmZmVjdHMgb3V0c2lkZSBvZiBzaWduYWxTbGljZSBpbnN0ZWFkLlwiLFxuXHRcdCk7XG5cdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KHNsaWNlLCBrZXksIHtcblx0XHRcdHZhbHVlOiBlZmZlY3QoKG9uQ2xlYW51cCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtYXliZUNsZWFudXAgPSBuYW1lZEVmZmVjdCgpO1xuXHRcdFx0XHRpZiAobWF5YmVDbGVhbnVwKSB7XG5cdFx0XHRcdFx0b25DbGVhbnVwKCgpID0+IG1heWJlQ2xlYW51cCgpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSksXG5cdFx0fSk7XG5cdH1cblxuXHRkZXN0cm95UmVmLm9uRGVzdHJveSgoKSA9PiB7XG5cdFx0c3Vicy5mb3JFYWNoKChzdWIpID0+IHN1Yi5jb21wbGV0ZSgpKTtcblx0fSk7XG5cblx0Y29uc3QgY29ubmVjdExhenlTb3VyY2VzID0gKCkgPT4ge1xuXHRcdGlmICghbGF6eVNvdXJjZXNMb2FkZWQpIHtcblx0XHRcdGxhenlTb3VyY2VzTG9hZGVkID0gdHJ1ZTtcblx0XHRcdGNvbm5lY3RTb3VyY2VzKHN0YXRlLCBsYXp5U291cmNlcywgaW5qZWN0b3IsIHRydWUpO1xuXHRcdH1cblx0fTtcblxuXHRyZXR1cm4gbmV3IFByb3h5KHNsaWNlLCB7XG5cdFx0Z2V0KHRhcmdldCwgcHJvcGVydHksIHJlY2VpdmVyKSB7XG5cdFx0XHRjb25uZWN0TGF6eVNvdXJjZXMoKTtcblx0XHRcdHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcik7XG5cdFx0fSxcblx0XHRhcHBseSh0YXJnZXQsIHRoaXNBcmcsIGFyZ3VtZW50c0xpc3QpIHtcblx0XHRcdGNvbm5lY3RMYXp5U291cmNlcygpO1xuXHRcdFx0cmV0dXJuIFJlZmxlY3QuYXBwbHkodGFyZ2V0LCB0aGlzQXJnLCBhcmd1bWVudHNMaXN0KTtcblx0XHR9LFxuXHR9KTtcbn1cblxuZnVuY3Rpb24gY29ubmVjdFNvdXJjZXM8VFNpZ25hbFZhbHVlPihcblx0c3RhdGU6IFdyaXRhYmxlU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdHNvdXJjZXM6IFNvdXJjZUNvbmZpZzxUU2lnbmFsVmFsdWU+LFxuXHRpbmplY3Rvcj86IEluamVjdG9yLFxuXHR1c2VVbnRyYWNrZWQgPSBmYWxzZSxcbikge1xuXHRmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7XG5cdFx0aWYgKGlzT2JzZXJ2YWJsZShzb3VyY2UpKSB7XG5cdFx0XHRjb25uZWN0KHN0YXRlLCBzb3VyY2UsIGluamVjdG9yLCB1c2VVbnRyYWNrZWQpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25uZWN0KHN0YXRlLCBzb3VyY2Uoc3RhdGUuYXNSZWFkb25seSgpKSwgaW5qZWN0b3IsIHVzZVVudHJhY2tlZCk7XG5cdFx0fVxuXHR9XG59XG5cbmZ1bmN0aW9uIGFkZFJlZHVjZXJQcm9wZXJ0aWVzKFxuXHRyZWFkb25seVN0YXRlOiBTaWduYWw8dW5rbm93bj4sXG5cdHN0YXRlJDogT2JzZXJ2YWJsZTx1bmtub3duPixcblx0a2V5OiBzdHJpbmcsXG5cdGRlc3Ryb3lSZWY6IERlc3Ryb3lSZWYsXG5cdHN1YmplY3Q6IFN1YmplY3Q8dW5rbm93bj4sXG5cdHN1YnM6IFN1YmplY3Q8dW5rbm93bj5bXSxcblx0b2JzZXJ2YWJsZUZyb21BY3Rpb25Tb3VyY2U/OiBPYnNlcnZhYmxlPGFueT4sXG4pIHtcblx0T2JqZWN0LmRlZmluZVByb3BlcnRpZXMocmVhZG9ubHlTdGF0ZSwge1xuXHRcdFtrZXldOiB7XG5cdFx0XHR2YWx1ZTogKG5leHRWYWx1ZTogdW5rbm93bikgPT4ge1xuXHRcdFx0XHRpZiAoaXNPYnNlcnZhYmxlKG5leHRWYWx1ZSkpIHtcblx0XHRcdFx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7XG5cdFx0XHRcdFx0XHRuZXh0VmFsdWUucGlwZSh0YWtlVW50aWxEZXN0cm95ZWQoZGVzdHJveVJlZikpLnN1YnNjcmliZSh7XG5cdFx0XHRcdFx0XHRcdG5leHQ6ICh2YWx1ZSkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdHN1YmplY3QubmV4dCh2YWx1ZSk7XG5cdFx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0XHRcdGVycm9yOiAoZXJyKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0c3ViamVjdC5lcnJvcihlcnIpO1xuXHRcdFx0XHRcdFx0XHRcdHJlaihlcnIpO1xuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHRjb21wbGV0ZTogKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdHN1YmplY3QuY29tcGxldGUoKTtcblx0XHRcdFx0XHRcdFx0XHRyZXMocmVhZG9ubHlTdGF0ZSgpKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKG9ic2VydmFibGVGcm9tQWN0aW9uU291cmNlKSB7XG5cdFx0XHRcdFx0b2JzZXJ2YWJsZUZyb21BY3Rpb25Tb3VyY2Vcblx0XHRcdFx0XHRcdC5waXBlKHRha2VVbnRpbERlc3Ryb3llZChkZXN0cm95UmVmKSlcblx0XHRcdFx0XHRcdC5zdWJzY3JpYmUoKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzKSA9PiB7XG5cdFx0XHRcdFx0c3RhdGUkLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKCh2YWwpID0+IHtcblx0XHRcdFx0XHRcdHJlcyh2YWwpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdHN1YmplY3QubmV4dChuZXh0VmFsdWUpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cdFx0fSxcblx0XHRbYCR7a2V5fSRgXToge1xuXHRcdFx0dmFsdWU6IHN1YmplY3QuYXNPYnNlcnZhYmxlKCksXG5cdFx0fSxcblx0fSk7XG5cdHN1YnMucHVzaChzdWJqZWN0KTtcbn1cbiJdfQ==