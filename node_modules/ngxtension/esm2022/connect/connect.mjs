import { DestroyRef, Injector, effect, untracked, } from '@angular/core';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { assertInjector } from 'ngxtension/assert-injector';
import { Subscription, isObservable } from 'rxjs';
export function connect(signal, ...args) {
    const [observable, reducer, injectorOrDestroyRef, useUntracked, originSignal,] = parseArgs(args);
    if (observable) {
        let destroyRef = null;
        if (injectorOrDestroyRef instanceof DestroyRef) {
            destroyRef = injectorOrDestroyRef; // if it's a DestroyRef, use it
        }
        else {
            const injector = assertInjector(connect, injectorOrDestroyRef);
            destroyRef = injector.get(DestroyRef);
        }
        return observable.pipe(takeUntilDestroyed(destroyRef)).subscribe((x) => {
            const update = () => {
                signal.update((prev) => {
                    if (!isObject(prev)) {
                        return reducer?.(prev, x) || x;
                    }
                    if (!isObject(x)) {
                        const reducedValue = reducer ? reducer(prev, x) : x;
                        return isObject(reducedValue)
                            ? { ...prev, ...reducedValue }
                            : reducedValue;
                    }
                    return { ...prev, ...(reducer?.(prev, x) || x) };
                });
            };
            if (useUntracked) {
                untracked(update);
            }
            else {
                update();
            }
        });
    }
    if (originSignal) {
        const injector = injectorOrDestroyRef instanceof Injector
            ? assertInjector(connect, injectorOrDestroyRef)
            : undefined;
        return effect(() => {
            signal.update((prev) => {
                if (!isObject(prev)) {
                    return originSignal();
                }
                return { ...prev, ...originSignal() };
            });
        }, {
            allowSignalWrites: true,
            injector,
        });
    }
    return {
        with(...args) {
            if (!this.subscription) {
                this.subscription = new Subscription();
            }
            else if (this.subscription.closed) {
                console.info(`[ngxtension connect] ConnectedSignal has been closed.`);
                return this;
            }
            this.subscription.add(connect(signal, ...args, injectorOrDestroyRef, useUntracked));
            return this;
        },
        subscription: null,
    };
}
// TODO: there must be a way to parse the args more efficiently
function parseArgs(args) {
    if (args.length > 3) {
        return [
            args[0],
            args[1],
            args[2],
            args[3],
            null,
        ];
    }
    if (args.length === 3) {
        if (typeof args[2] === 'boolean') {
            if (isObservable(args[0])) {
                return [
                    args[0],
                    null,
                    args[1],
                    args[2],
                    null,
                ];
            }
            else {
                return [
                    null,
                    null,
                    args[1],
                    args[2],
                    args[0],
                ];
            }
        }
        return [
            args[0],
            args[1],
            args[2],
            false,
            null,
        ];
    }
    if (args.length === 2) {
        if (typeof args[1] === 'boolean') {
            return [null, null, args[0], args[1], null];
        }
        if (typeof args[1] === 'function') {
            return [
                args[0],
                args[1],
                null,
                false,
                null,
            ];
        }
        return [
            args[0],
            null,
            args[1],
            false,
            null,
        ];
    }
    if (isObservable(args[0])) {
        return [args[0], null, null, false, null];
    }
    // to connect signals to other signals, we need to use a callback that includes a signal call
    if (typeof args[0] === 'function') {
        return [null, null, null, false, args[0]];
    }
    return [null, null, args[0], false, null];
}
function isObject(val) {
    return (typeof val === 'object' &&
        val !== undefined &&
        val !== null &&
        !Array.isArray(val));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4dGVuc2lvbi9jb25uZWN0L3NyYy9jb25uZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixVQUFVLEVBQ1YsUUFBUSxFQUNSLE1BQU0sRUFDTixTQUFTLEdBR1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFtQixNQUFNLE1BQU0sQ0FBQztBQXlGbkUsTUFBTSxVQUFVLE9BQU8sQ0FBQyxNQUErQixFQUFFLEdBQUcsSUFBVztJQUN0RSxNQUFNLENBQ0wsVUFBVSxFQUNWLE9BQU8sRUFDUCxvQkFBb0IsRUFDcEIsWUFBWSxFQUNaLFlBQVksRUFDWixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVwQixJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2hCLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQztRQUV0QixJQUFJLG9CQUFvQixZQUFZLFVBQVUsRUFBRSxDQUFDO1lBQ2hELFVBQVUsR0FBRyxvQkFBb0IsQ0FBQyxDQUFDLCtCQUErQjtRQUNuRSxDQUFDO2FBQU0sQ0FBQztZQUNQLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxPQUFPLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztZQUMvRCxVQUFVLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2QyxDQUFDO1FBRUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDdEUsTUFBTSxNQUFNLEdBQUcsR0FBRyxFQUFFO2dCQUNu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Q0FBQyxDQUF3QjtnQkFDOUIsSUFBSSxDQUFDLENBQUMsQ0FBOEI7Z0JBQ3BDLElBQUk7Z0JBQ0osS0FBSztnQkFDTCxJQUFJO2FBQ0osQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPO1lBQ04sSUFBSSxDQUFDLENBQUMsQ0FBd0I7WUFDOUIsSUFBSTtZQUNKLElBQUksQ0FBQyxDQUFDLENBQTBCO1lBQ2hDLEtBQUs7WUFDTCxJQUFJO1NBQ0osQ0FBQztJQUNILENBQUM7SUFFRCxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUF3QixFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCw2RkFBNkY7SUFDN0YsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxVQUFVLEVBQUUsQ0FBQztRQUNuQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQWtCLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBMEIsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDcEUsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQVE7SUFDekIsT0FBTyxDQUNOLE9BQU8sR0FBRyxLQUFLLFFBQVE7UUFDdkIsR0FBRyxLQUFLLFNBQVM7UUFDakIsR0FBRyxLQUFLLElBQUk7UUFDWixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQ25CLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0RGVzdHJveVJlZixcblx0SW5qZWN0b3IsXG5cdGVmZmVjdCxcblx0dW50cmFja2VkLFxuXHR0eXBlIEVmZmVjdFJlZixcblx0dHlwZSBXcml0YWJsZVNpZ25hbCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0YWtlVW50aWxEZXN0cm95ZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5pbXBvcnQgeyBhc3NlcnRJbmplY3RvciB9IGZyb20gJ25neHRlbnNpb24vYXNzZXJ0LWluamVjdG9yJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgaXNPYnNlcnZhYmxlLCB0eXBlIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IHR5cGUgUGFydGlhbE9yVmFsdWU8VFZhbHVlPiA9IFRWYWx1ZSBleHRlbmRzIG9iamVjdFxuXHQ/IFBhcnRpYWw8VFZhbHVlPlxuXHQ6IFRWYWx1ZTtcbmV4cG9ydCB0eXBlIFJlZHVjZXI8VFZhbHVlLCBUTmV4dD4gPSAoXG5cdHByZXZpb3VzOiBUVmFsdWUsXG5cdG5leHQ6IFROZXh0LFxuKSA9PiBQYXJ0aWFsT3JWYWx1ZTxUVmFsdWU+O1xuXG50eXBlIENvbm5lY3RlZFNpZ25hbDxUU2lnbmFsVmFsdWU+ID0ge1xuXHR3aXRoPFRPYnNlcnZhYmxlVmFsdWUgZXh0ZW5kcyBQYXJ0aWFsT3JWYWx1ZTxUU2lnbmFsVmFsdWU+Pihcblx0XHRvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPFRPYnNlcnZhYmxlVmFsdWU+LFxuXHQpOiBDb25uZWN0ZWRTaWduYWw8VFNpZ25hbFZhbHVlPjtcblx0d2l0aDxUT2JzZXJ2YWJsZVZhbHVlPihcblx0XHRvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPFRPYnNlcnZhYmxlVmFsdWU+LFxuXHRcdHJlZHVjZXI6IFJlZHVjZXI8VFNpZ25hbFZhbHVlLCBUT2JzZXJ2YWJsZVZhbHVlPixcblx0KTogQ29ubmVjdGVkU2lnbmFsPFRTaWduYWxWYWx1ZT47XG5cdHdpdGg8VE9yaWdpblNpZ25hbFZhbHVlIGV4dGVuZHMgUGFydGlhbE9yVmFsdWU8VFNpZ25hbFZhbHVlPj4oXG5cdFx0b3JpZ2luU2lnbmFsOiAoKSA9PiBUT3JpZ2luU2lnbmFsVmFsdWUsXG5cdCk6IENvbm5lY3RlZFNpZ25hbDxUU2lnbmFsVmFsdWU+O1xuXHRzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbn07XG5cbi8qKlxuICogQ29ubmVjdHMgYSBzaWduYWwgdG8gYW4gb2JzZXJ2YWJsZSBhbmQgcmV0dXJucyBhIHN1YnNjcmlwdGlvbi4gVGhlIHN1YnNjcmlwdGlvbiBpcyBhdXRvbWF0aWNhbGx5XG4gKiB1bnN1YnNjcmliZWQgd2hlbiB0aGUgY29tcG9uZW50IGlzIGRlc3Ryb3llZC4gSWYgaXQncyBub3QgY2FsbGVkIGluIGFuIGluamVjdGlvbiBjb250ZXh0LCBpdCBtdXN0XG4gKiBiZSBjYWxsZWQgd2l0aCBhbiBpbmplY3RvciBvciBEZXN0cm95UmVmLlxuICpcbiAqXG4gKiBVc2FnZVxuICogYGBgdHNcbiAqIEBDb21wb25lbnQoe30pXG4gKiBleHBvcnQgY2xhc3MgTXlDb21wb25lbnQge1xuICogIHByaXZhdGUgZGF0YVNlcnZpY2UgPSBpbmplY3QoRGF0YVNlcnZpY2UpO1xuICpcbiAqICBkYXRhID0gc2lnbmFsKFtdIGFzIHN0cmluZ1tdKTtcbiAqXG4gKiAgY29uc3RydWN0b3IoKSB7XG4gKiAgICBjb25uZWN0KHRoaXMuZGF0YSwgdGhpcy5kYXRhU2VydmljZS5kYXRhJCk7XG4gKiAgfVxuICogfVxuICogYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb25uZWN0PFRTaWduYWxWYWx1ZT4oXG5cdHNpZ25hbDogV3JpdGFibGVTaWduYWw8VFNpZ25hbFZhbHVlPixcblx0aW5qZWN0b3JPckRlc3Ryb3lSZWY/OiBJbmplY3RvciB8IERlc3Ryb3lSZWYsXG5cdHVzZVVudHJhY2tlZD86IGJvb2xlYW4sXG4pOiBDb25uZWN0ZWRTaWduYWw8VFNpZ25hbFZhbHVlPjtcblxuLyoqXG4gKiBDb25uZWN0cyBhIHNpZ25hbCB0byBhbm90aGVyIHNpZ25hbCB2YWx1ZS5cbiAqIEBwYXJhbSBzaWduYWwgVGhlIHNpZ25hbCB0byBjb25uZWN0IHRvLlxuICogQHBhcmFtIG9yaWdpblNpZ25hbCBBIGNhbGxiYWNrIGZuIHRoYXQgaW5jbHVkZXMgYSBzaWduYWwgY2FsbC4gVGhlIHNpZ25hbCBjYWxsIHdpbGwgYmUgdHJhY2tlZC5cbiAqXG4gKiBVc2FnZVxuICogYGBgdHNcbiAqIGV4cG9ydCBjbGFzcyBNeUNvbXBvbmVudCB7XG4gKiBcdHByaXZhdGUgZGF0YVNlcnZpY2UgPSBpbmplY3QoRGF0YVNlcnZpY2UpO1xuICpcbiAqIFx0bmFtZSA9IHNpZ25hbCgnJyk7XG4gKlxuICogIGNvbnN0cnVjdG9yKCkge1xuICogICAgY29ubmVjdCh0aGlzLm5hbWUsICgpID0+IHRoaXMuZGF0YVNlcnZpY2UudXNlcigpLm5hbWUpO1xuICogIH1cbiAqIH1cbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdDxUU2lnbmFsVmFsdWU+KFxuXHRzaWduYWw6IFdyaXRhYmxlU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdG9yaWdpblNpZ25hbDogKCkgPT4gVFNpZ25hbFZhbHVlLFxuKTogRWZmZWN0UmVmO1xuXG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdDxcblx0VFNpZ25hbFZhbHVlLFxuXHRUT2JzZXJ2YWJsZVZhbHVlIGV4dGVuZHMgUGFydGlhbE9yVmFsdWU8VFNpZ25hbFZhbHVlPixcbj4oXG5cdHNpZ25hbDogV3JpdGFibGVTaWduYWw8VFNpZ25hbFZhbHVlPixcblx0b2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUT2JzZXJ2YWJsZVZhbHVlPixcblx0aW5qZWN0b3JPckRlc3Ryb3lSZWY/OiBJbmplY3RvciB8IERlc3Ryb3lSZWYsXG5cdHVzZVVudHJhY2tlZD86IGJvb2xlYW4sXG4pOiBTdWJzY3JpcHRpb247XG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdDxUU2lnbmFsVmFsdWUsIFRPYnNlcnZhYmxlVmFsdWU+KFxuXHRzaWduYWw6IFdyaXRhYmxlU2lnbmFsPFRTaWduYWxWYWx1ZT4sXG5cdG9ic2VydmFibGU6IE9ic2VydmFibGU8VE9ic2VydmFibGVWYWx1ZT4sXG5cdHJlZHVjZXI6IFJlZHVjZXI8VFNpZ25hbFZhbHVlLCBUT2JzZXJ2YWJsZVZhbHVlPixcblx0aW5qZWN0b3JPckRlc3Ryb3lSZWY/OiBJbmplY3RvciB8IERlc3Ryb3lSZWYsXG5cdHVzZVVudHJhY2tlZD86IGJvb2xlYW4sXG4pOiBTdWJzY3JpcHRpb247XG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdChzaWduYWw6IFdyaXRhYmxlU2lnbmFsPHVua25vd24+LCAuLi5hcmdzOiBhbnlbXSkge1xuXHRjb25zdCBbXG5cdFx0b2JzZXJ2YWJsZSxcblx0XHRyZWR1Y2VyLFxuXHRcdGluamVjdG9yT3JEZXN0cm95UmVmLFxuXHRcdHVzZVVudHJhY2tlZCxcblx0XHRvcmlnaW5TaWduYWwsXG5cdF0gPSBwYXJzZUFyZ3MoYXJncyk7XG5cblx0aWYgKG9ic2VydmFibGUpIHtcblx0XHRsZXQgZGVzdHJveVJlZiA9IG51bGw7XG5cblx0XHRpZiAoaW5qZWN0b3JPckRlc3Ryb3lSZWYgaW5zdGFuY2VvZiBEZXN0cm95UmVmKSB7XG5cdFx0XHRkZXN0cm95UmVmID0gaW5qZWN0b3JPckRlc3Ryb3lSZWY7IC8vIGlmIGl0J3MgYSBEZXN0cm95UmVmLCB1c2UgaXRcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgaW5qZWN0b3IgPSBhc3NlcnRJbmplY3Rvcihjb25uZWN0LCBpbmplY3Rvck9yRGVzdHJveVJlZik7XG5cdFx0XHRkZXN0cm95UmVmID0gaW5qZWN0b3IuZ2V0KERlc3Ryb3lSZWYpO1xuXHRcdH1cblxuXHRcdHJldHVybiBvYnNlcnZhYmxlLnBpcGUodGFrZVVudGlsRGVzdHJveWVkKGRlc3Ryb3lSZWYpKS5zdWJzY3JpYmUoKHgpID0+IHtcblx0XHRcdGNvbnN0IHVwZGF0ZSA9ICgpID0+IHtcblx0XHRcdFx0c2lnbmFsLnVwZGF0ZSgocHJldikgPT4ge1xuXHRcdFx0XHRcdGlmICghaXNPYmplY3QocHJldikpIHtcblx0XHRcdFx0XHRcdHJldHVybiByZWR1Y2VyPy4ocHJldiwgeCkgfHwgeDtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoIWlzT2JqZWN0KHgpKSB7XG5cdFx0XHRcdFx0XHRjb25zdCByZWR1Y2VkVmFsdWUgPSByZWR1Y2VyID8gcmVkdWNlcihwcmV2LCB4KSA6IHg7XG5cdFx0XHRcdFx0XHRyZXR1cm4gaXNPYmplY3QocmVkdWNlZFZhbHVlKVxuXHRcdFx0XHRcdFx0XHQ/IHsgLi4ucHJldiwgLi4uKHJlZHVjZWRWYWx1ZSBhcyBvYmplY3QpIH1cblx0XHRcdFx0XHRcdFx0OiByZWR1Y2VkVmFsdWU7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0cmV0dXJuIHsgLi4ucHJldiwgLi4uKChyZWR1Y2VyPy4ocHJldiwgeCkgfHwgeCkgYXMgb2JqZWN0KSB9O1xuXHRcdFx0XHR9KTtcblx0XHRcdH07XG5cblx0XHRcdGlmICh1c2VVbnRyYWNrZWQpIHtcblx0XHRcdFx0dW50cmFja2VkKHVwZGF0ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR1cGRhdGUoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGlmIChvcmlnaW5TaWduYWwpIHtcblx0XHRjb25zdCBpbmplY3RvciA9XG5cdFx0XHRpbmplY3Rvck9yRGVzdHJveVJlZiBpbnN0YW5jZW9mIEluamVjdG9yXG5cdFx0XHRcdD8gYXNzZXJ0SW5qZWN0b3IoY29ubmVjdCwgaW5qZWN0b3JPckRlc3Ryb3lSZWYpXG5cdFx0XHRcdDogdW5kZWZpbmVkO1xuXG5cdFx0cmV0dXJuIGVmZmVjdChcblx0XHRcdCgpID0+IHtcblx0XHRcdFx0c2lnbmFsLnVwZGF0ZSgocHJldikgPT4ge1xuXHRcdFx0XHRcdGlmICghaXNPYmplY3QocHJldikpIHtcblx0XHRcdFx0XHRcdHJldHVybiBvcmlnaW5TaWduYWwoKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXR1cm4geyAuLi5wcmV2LCAuLi4ob3JpZ2luU2lnbmFsKCkgYXMgb2JqZWN0KSB9O1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cdFx0XHR7XG5cdFx0XHRcdGFsbG93U2lnbmFsV3JpdGVzOiB0cnVlLFxuXHRcdFx0XHRpbmplY3Rvcixcblx0XHRcdH0sXG5cdFx0KTtcblx0fVxuXG5cdHJldHVybiB7XG5cdFx0d2l0aCh0aGlzOiBDb25uZWN0ZWRTaWduYWw8dW5rbm93bj4sIC4uLmFyZ3M6IHVua25vd25bXSkge1xuXHRcdFx0aWYgKCF0aGlzLnN1YnNjcmlwdGlvbikge1xuXHRcdFx0XHR0aGlzLnN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblx0XHRcdH0gZWxzZSBpZiAodGhpcy5zdWJzY3JpcHRpb24uY2xvc2VkKSB7XG5cdFx0XHRcdGNvbnNvbGUuaW5mbyhgW25neHRlbnNpb24gY29ubmVjdF0gQ29ubmVjdGVkU2lnbmFsIGhhcyBiZWVuIGNsb3NlZC5gKTtcblx0XHRcdFx0cmV0dXJuIHRoaXM7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG5cdFx0XHRcdGNvbm5lY3QoXG5cdFx0XHRcdFx0c2lnbmFsLFxuXHRcdFx0XHRcdC4uLihhcmdzIGFzIGFueSksXG5cdFx0XHRcdFx0aW5qZWN0b3JPckRlc3Ryb3lSZWYgYXMgYW55LFxuXHRcdFx0XHRcdHVzZVVudHJhY2tlZCxcblx0XHRcdFx0KSBhcyB1bmtub3duIGFzIFN1YnNjcmlwdGlvbixcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm4gdGhpcztcblx0XHR9LFxuXHRcdHN1YnNjcmlwdGlvbjogbnVsbCEsXG5cdH0gYXMgQ29ubmVjdGVkU2lnbmFsPHVua25vd24+O1xufVxuXG4vLyBUT0RPOiB0aGVyZSBtdXN0IGJlIGEgd2F5IHRvIHBhcnNlIHRoZSBhcmdzIG1vcmUgZWZmaWNpZW50bHlcbmZ1bmN0aW9uIHBhcnNlQXJncyhcblx0YXJnczogYW55W10sXG4pOiBbXG5cdE9ic2VydmFibGU8dW5rbm93bj4gfCBudWxsLFxuXHRSZWR1Y2VyPHVua25vd24sIHVua25vd24+IHwgbnVsbCxcblx0SW5qZWN0b3IgfCBEZXN0cm95UmVmIHwgbnVsbCxcblx0Ym9vbGVhbixcblx0KCgpID0+IHVua25vd24pIHwgbnVsbCxcbl0ge1xuXHRpZiAoYXJncy5sZW5ndGggPiAzKSB7XG5cdFx0cmV0dXJuIFtcblx0XHRcdGFyZ3NbMF0gYXMgT2JzZXJ2YWJsZTx1bmtub3duPixcblx0XHRcdGFyZ3NbMV0gYXMgUmVkdWNlcjx1bmtub3duLCB1bmtub3duPixcblx0XHRcdGFyZ3NbMl0gYXMgSW5qZWN0b3IgfCBEZXN0cm95UmVmLFxuXHRcdFx0YXJnc1szXSBhcyBib29sZWFuLFxuXHRcdFx0bnVsbCxcblx0XHRdO1xuXHR9XG5cblx0aWYgKGFyZ3MubGVuZ3RoID09PSAzKSB7XG5cdFx0aWYgKHR5cGVvZiBhcmdzWzJdID09PSAnYm9vbGVhbicpIHtcblx0XHRcdGlmIChpc09ic2VydmFibGUoYXJnc1swXSkpIHtcblx0XHRcdFx0cmV0dXJuIFtcblx0XHRcdFx0XHRhcmdzWzBdIGFzIE9ic2VydmFibGU8dW5rbm93bj4sXG5cdFx0XHRcdFx0bnVsbCxcblx0XHRcdFx0XHRhcmdzWzFdIGFzIEluamVjdG9yIHwgRGVzdHJveVJlZixcblx0XHRcdFx0XHRhcmdzWzJdLFxuXHRcdFx0XHRcdG51bGwsXG5cdFx0XHRcdF07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZXR1cm4gW1xuXHRcdFx0XHRcdG51bGwsXG5cdFx0XHRcdFx0bnVsbCxcblx0XHRcdFx0XHRhcmdzWzFdIGFzIEluamVjdG9yIHwgRGVzdHJveVJlZixcblx0XHRcdFx0XHRhcmdzWzJdLFxuXHRcdFx0XHRcdGFyZ3NbMF0gYXMgKCkgPT4gdW5rbm93bixcblx0XHRcdFx0XTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0YXJnc1swXSBhcyBPYnNlcnZhYmxlPHVua25vd24+LFxuXHRcdFx0YXJnc1sxXSBhcyBSZWR1Y2VyPHVua25vd24sIHVua25vd24+LFxuXHRcdFx0YXJnc1syXSBhcyBJbmplY3RvciB8IERlc3Ryb3lSZWYsXG5cdFx0XHRmYWxzZSxcblx0XHRcdG51bGwsXG5cdFx0XTtcblx0fVxuXG5cdGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuXHRcdGlmICh0eXBlb2YgYXJnc1sxXSA9PT0gJ2Jvb2xlYW4nKSB7XG5cdFx0XHRyZXR1cm4gW251bGwsIG51bGwsIGFyZ3NbMF0gYXMgSW5qZWN0b3IgfCBEZXN0cm95UmVmLCBhcmdzWzFdLCBudWxsXTtcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIGFyZ3NbMV0gPT09ICdmdW5jdGlvbicpIHtcblx0XHRcdHJldHVybiBbXG5cdFx0XHRcdGFyZ3NbMF0gYXMgT2JzZXJ2YWJsZTx1bmtub3duPixcblx0XHRcdFx0YXJnc1sxXSBhcyBSZWR1Y2VyPHVua25vd24sIHVua25vd24+LFxuXHRcdFx0XHRudWxsLFxuXHRcdFx0XHRmYWxzZSxcblx0XHRcdFx0bnVsbCxcblx0XHRcdF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIFtcblx0XHRcdGFyZ3NbMF0gYXMgT2JzZXJ2YWJsZTx1bmtub3duPixcblx0XHRcdG51bGwsXG5cdFx0XHRhcmdzWzFdIGFzIEluamVjdG9yIHwgRGVzdHJveVJlZixcblx0XHRcdGZhbHNlLFxuXHRcdFx0bnVsbCxcblx0XHRdO1xuXHR9XG5cblx0aWYgKGlzT2JzZXJ2YWJsZShhcmdzWzBdKSkge1xuXHRcdHJldHVybiBbYXJnc1swXSBhcyBPYnNlcnZhYmxlPHVua25vd24+LCBudWxsLCBudWxsLCBmYWxzZSwgbnVsbF07XG5cdH1cblxuXHQvLyB0byBjb25uZWN0IHNpZ25hbHMgdG8gb3RoZXIgc2lnbmFscywgd2UgbmVlZCB0byB1c2UgYSBjYWxsYmFjayB0aGF0IGluY2x1ZGVzIGEgc2lnbmFsIGNhbGxcblx0aWYgKHR5cGVvZiBhcmdzWzBdID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0cmV0dXJuIFtudWxsLCBudWxsLCBudWxsLCBmYWxzZSwgYXJnc1swXSBhcyAoKSA9PiB1bmtub3duXTtcblx0fVxuXG5cdHJldHVybiBbbnVsbCwgbnVsbCwgYXJnc1swXSBhcyBJbmplY3RvciB8IERlc3Ryb3lSZWYsIGZhbHNlLCBudWxsXTtcbn1cblxuZnVuY3Rpb24gaXNPYmplY3QodmFsOiBhbnkpOiB2YWwgaXMgb2JqZWN0IHtcblx0cmV0dXJuIChcblx0XHR0eXBlb2YgdmFsID09PSAnb2JqZWN0JyAmJlxuXHRcdHZhbCAhPT0gdW5kZWZpbmVkICYmXG5cdFx0dmFsICE9PSBudWxsICYmXG5cdFx0IUFycmF5LmlzQXJyYXkodmFsKVxuXHQpO1xufVxuIl19