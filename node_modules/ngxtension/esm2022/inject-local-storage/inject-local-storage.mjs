import { DestroyRef, InjectionToken, effect, inject, signal, } from '@angular/core';
import { assertInjector } from 'ngxtension/assert-injector';
export const NGXTENSION_LOCAL_STORAGE = new InjectionToken('NGXTENSION_LOCAL_STORAGE', {
    providedIn: 'root',
    factory: () => localStorage, // this would be the default
});
export function provideLocalStorageImpl(impl) {
    return {
        provide: NGXTENSION_LOCAL_STORAGE,
        useValue: impl,
    };
}
function isFunction(value) {
    return typeof value === 'function';
}
function goodTry(tryFn) {
    try {
        return tryFn();
    }
    catch {
        return undefined;
    }
}
function parseJSON(value) {
    return value === 'undefined' ? undefined : JSON.parse(value);
}
export const injectLocalStorage = (key, options = {}) => {
    const defaultValue = isFunction(options.defaultValue)
        ? options.defaultValue()
        : options.defaultValue;
    const stringify = isFunction(options.stringify)
        ? options.stringify
        : JSON.stringify;
    const parse = isFunction(options.parse) ? options.parse : parseJSON;
    const storageSync = options.storageSync ?? true;
    return assertInjector(injectLocalStorage, options.injector, () => {
        const localStorage = inject(NGXTENSION_LOCAL_STORAGE);
        const destroyRef = inject(DestroyRef);
        const initialStoredValue = goodTry(() => localStorage.getItem(key));
        const initialValue = initialStoredValue
            ? goodTry(() => parse(initialStoredValue))
            : defaultValue;
        const internalSignal = signal(initialValue);
        effect(() => {
            const value = internalSignal();
            if (value === undefined) {
                goodTry(() => localStorage.removeItem(key));
            }
            else {
                goodTry(() => localStorage.setItem(key, stringify(value)));
            }
        });
        if (storageSync) {
            const onStorage = (event) => {
                if (event.storageArea === localStorage && event.key === key) {
                    const newValue = event.newValue !== null ? parse(event.newValue) : undefined;
                    internalSignal.set(newValue);
                }
            };
            window.addEventListener('storage', onStorage);
            destroyRef.onDestroy(() => {
                window.removeEventListener('storage', onStorage);
            });
        }
        return internalSignal;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LWxvY2FsLXN0b3JhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neHRlbnNpb24vaW5qZWN0LWxvY2FsLXN0b3JhZ2Uvc3JjL2luamVjdC1sb2NhbC1zdG9yYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixVQUFVLEVBQ1YsY0FBYyxFQUNkLE1BQU0sRUFDTixNQUFNLEVBQ04sTUFBTSxHQUdOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU1RCxNQUFNLENBQUMsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLGNBQWMsQ0FDekQsMEJBQTBCLEVBQzFCO0lBQ0MsVUFBVSxFQUFFLE1BQU07SUFDbEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLFlBQVksRUFBRSw0QkFBNEI7Q0FDekQsQ0FDRCxDQUFDO0FBRUYsTUFBTSxVQUFVLHVCQUF1QixDQUFDLElBQW9DO0lBQzNFLE9BQU87UUFDTixPQUFPLEVBQUUsd0JBQXdCO1FBQ2pDLFFBQVEsRUFBRSxJQUFJO0tBQ2QsQ0FBQztBQUNILENBQUM7QUFrQ0QsU0FBUyxVQUFVLENBQUMsS0FBYztJQUNqQyxPQUFPLE9BQU8sS0FBSyxLQUFLLFVBQVUsQ0FBQztBQUNwQyxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUksS0FBYztJQUNqQyxJQUFJLENBQUM7UUFDSixPQUFPLEtBQUssRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFBQyxNQUFNLENBQUM7UUFDUixPQUFPLFNBQVMsQ0FBQztJQUNsQixDQUFDO0FBQ0YsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEtBQWE7SUFDL0IsT0FBTyxLQUFLLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDOUQsQ0FBQztBQUVELE1B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amVjdGlvblRva2VuLFxuXHRlZmZlY3QsXG5cdGluamVjdCxcblx0c2lnbmFsLFxuXHR0eXBlIEluamVjdG9yLFxuXHR0eXBlIFdyaXRhYmxlU2lnbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFzc2VydEluamVjdG9yIH0gZnJvbSAnbmd4dGVuc2lvbi9hc3NlcnQtaW5qZWN0b3InO1xuXG5leHBvcnQgY29uc3QgTkdYVEVOU0lPTl9MT0NBTF9TVE9SQUdFID0gbmV3IEluamVjdGlvblRva2VuKFxuXHQnTkdYVEVOU0lPTl9MT0NBTF9TVE9SQUdFJyxcblx0e1xuXHRcdHByb3ZpZGVkSW46ICdyb290Jyxcblx0XHRmYWN0b3J5OiAoKSA9PiBsb2NhbFN0b3JhZ2UsIC8vIHRoaXMgd291bGQgYmUgdGhlIGRlZmF1bHRcblx0fSxcbik7XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlTG9jYWxTdG9yYWdlSW1wbChpbXBsOiB0eXBlb2YgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2UpIHtcblx0cmV0dXJuIHtcblx0XHRwcm92aWRlOiBOR1hURU5TSU9OX0xPQ0FMX1NUT1JBR0UsXG5cdFx0dXNlVmFsdWU6IGltcGwsXG5cdH07XG59XG5cbi8qKlxuICogT3B0aW9ucyB0byBvdmVycmlkZSB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUgbG9jYWwgc3RvcmFnZSBzaWduYWwuXG4gKi9cbmV4cG9ydCB0eXBlIExvY2FsU3RvcmFnZU9wdGlvbnM8VD4gPSB7XG5cdC8qKlxuXHQgKiBUaGUgZGVmYXVsdCB2YWx1ZSB0byB1c2Ugd2hlbiB0aGUga2V5IGlzIG5vdCBwcmVzZW50IGluIGxvY2FsIHN0b3JhZ2UuXG5cdCAqL1xuXHRkZWZhdWx0VmFsdWU/OiBUIHwgKCgpID0+IFQpO1xuXHQvKipcblx0ICpcblx0ICogRGV0ZXJtaW5lcyBpZiBsb2NhbCBzdG9yYWdlIHN5bmNzIHdpdGggdGhlIHNpZ25hbC5cblx0ICogV2hlbiB0cnVlLCB1cGRhdGVzIGluIG9uZSB0YWIgcmVmbGVjdCBpbiBvdGhlcnMsIGlkZWFsIGZvciBzaGFyZWQtc3RhdGUgYXBwcy5cblx0ICogRGVmYXVsdHMgdG8gdHJ1ZS5cblx0ICovXG5cdHN0b3JhZ2VTeW5jPzogYm9vbGVhbjtcblx0LyoqXG5cdCAqIE92ZXJyaWRlIHRoZSBkZWZhdWx0IEpTT04uc3RyaW5naWZ5IGZ1bmN0aW9uIGZvciBjdXN0b20gc2VyaWFsaXphdGlvbi5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqL1xuXHRzdHJpbmdpZnk/OiAodmFsdWU6IHVua25vd24pID0+IHN0cmluZztcblx0LyoqXG5cdCAqIE92ZXJyaWRlIHRoZSBkZWZhdWx0IEpTT04ucGFyc2UgZnVuY3Rpb24gZm9yIGN1c3RvbSBkZXNlcmlhbGl6YXRpb24uXG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0cGFyc2U/OiAodmFsdWU6IHN0cmluZykgPT4gdW5rbm93bjtcblxuXHQvKipcblx0ICogSW5qZWN0b3IgZm9yIHRoZSBJbmplY3Rpb24gQ29udGV4dFxuXHQgKi9cblx0aW5qZWN0b3I/OiBJbmplY3Rvcjtcbn07XG5cbmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWU6IHVua25vd24pOiB2YWx1ZSBpcyAoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duIHtcblx0cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJztcbn1cblxuZnVuY3Rpb24gZ29vZFRyeTxUPih0cnlGbjogKCkgPT4gVCk6IFQgfCB1bmRlZmluZWQge1xuXHR0cnkge1xuXHRcdHJldHVybiB0cnlGbigpO1xuXHR9IGNhdGNoIHtcblx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHR9XG59XG5cbmZ1bmN0aW9uIHBhcnNlSlNPTih2YWx1ZTogc3RyaW5nKTogdW5rbm93biB7XG5cdHJldHVybiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgPyB1bmRlZmluZWQgOiBKU09OLnBhcnNlKHZhbHVlKTtcbn1cblxuZXhwb3J0IGNvbnN0IGluamVjdExvY2FsU3RvcmFnZSA9IDxUPihcblx0a2V5OiBzdHJpbmcsXG5cdG9wdGlvbnM6IExvY2FsU3RvcmFnZU9wdGlvbnM8VD4gPSB7fSxcbik6IFdyaXRhYmxlU2lnbmFsPFQgfCB1bmRlZmluZWQ+ID0+IHtcblx0Y29uc3QgZGVmYXVsdFZhbHVlID0gaXNGdW5jdGlvbihvcHRpb25zLmRlZmF1bHRWYWx1ZSlcblx0XHQ/IG9wdGlvbnMuZGVmYXVsdFZhbHVlKClcblx0XHQ6IG9wdGlvbnMuZGVmYXVsdFZhbHVlO1xuXHRjb25zdCBzdHJpbmdpZnkgPSBpc0Z1bmN0aW9uKG9wdGlvbnMuc3RyaW5naWZ5KVxuXHRcdD8gb3B0aW9ucy5zdHJpbmdpZnlcblx0XHQ6IEpTT04uc3RyaW5naWZ5O1xuXHRjb25zdCBwYXJzZSA9IGlzRnVuY3Rpb24ob3B0aW9ucy5wYXJzZSkgPyBvcHRpb25zLnBhcnNlIDogcGFyc2VKU09OO1xuXHRjb25zdCBzdG9yYWdlU3luYyA9IG9wdGlvbnMuc3RvcmFnZVN5bmMgPz8gdHJ1ZTtcblxuXHRyZXR1cm4gYXNzZXJ0SW5qZWN0b3IoaW5qZWN0TG9jYWxTdG9yYWdlLCBvcHRpb25zLmluamVjdG9yLCAoKSA9PiB7XG5cdFx0Y29uc3QgbG9jYWxTdG9yYWdlID0gaW5qZWN0KE5HWFRFTlNJT05fTE9DQUxfU1RPUkFHRSk7XG5cdFx0Y29uc3QgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcblxuXHRcdGNvbnN0IGluaXRpYWxTdG9yZWRWYWx1ZSA9IGdvb2RUcnkoKCkgPT4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KSk7XG5cdFx0Y29uc3QgaW5pdGlhbFZhbHVlID0gaW5pdGlhbFN0b3JlZFZhbHVlXG5cdFx0XHQ/IGdvb2RUcnkoKCkgPT4gcGFyc2UoaW5pdGlhbFN0b3JlZFZhbHVlKSBhcyBUKVxuXHRcdFx0OiBkZWZhdWx0VmFsdWU7XG5cdFx0Y29uc3QgaW50ZXJuYWxTaWduYWwgPSBzaWduYWw8VCB8IHVuZGVmaW5lZD4oaW5pdGlhbFZhbHVlKTtcblxuXHRcdGVmZmVjdCgoKSA9PiB7XG5cdFx0XHRjb25zdCB2YWx1ZSA9IGludGVybmFsU2lnbmFsKCk7XG5cdFx0XHRpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRnb29kVHJ5KCgpID0+IGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSkpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Z29vZFRyeSgoKSA9PiBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHN0cmluZ2lmeSh2YWx1ZSkpKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGlmIChzdG9yYWdlU3luYykge1xuXHRcdFx0Y29uc3Qgb25TdG9yYWdlID0gKGV2ZW50OiBTdG9yYWdlRXZlbnQpID0+IHtcblx0XHRcdFx0aWYgKGV2ZW50LnN0b3JhZ2VBcmVhID09PSBsb2NhbFN0b3JhZ2UgJiYgZXZlbnQua2V5ID09PSBrZXkpIHtcblx0XHRcdFx0XHRjb25zdCBuZXdWYWx1ZSA9XG5cdFx0XHRcdFx0XHRldmVudC5uZXdWYWx1ZSAhPT0gbnVsbCA/IChwYXJzZShldmVudC5uZXdWYWx1ZSkgYXMgVCkgOiB1bmRlZmluZWQ7XG5cdFx0XHRcdFx0aW50ZXJuYWxTaWduYWwuc2V0KG5ld1ZhbHVlKTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblxuXHRcdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3N0b3JhZ2UnLCBvblN0b3JhZ2UpO1xuXHRcdFx0ZGVzdHJveVJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuXHRcdFx0XHR3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc3RvcmFnZScsIG9uU3RvcmFnZSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gaW50ZXJuYWxTaWduYWw7XG5cdH0pO1xufTtcbiJdfQ==